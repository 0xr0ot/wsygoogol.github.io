<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>WAF Bypass 技巧总结 | SY0U&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="waf分类掌握绕过各类WAF可以说是渗透测试人员的一项基本技能，本文将WAF分为云WAF、硬件WAF、软件WAF、代码级WAF，分别从各自的特性来谈一些相关的绕过技巧，更侧重于针对基于规则类的WAF绕过技巧。 1.云WAFEg:加速乐目前CDN服务的功能是越来越多，安全性也越加强悍，用户的每个请求都会被发送到指定的CDN节点上，最后转发给真实站点。这个过程就好像加了一道关卡，这个关卡提供了缓存、加">
<meta property="og:type" content="article">
<meta property="og:title" content="WAF Bypass 技巧总结">
<meta property="og:url" content="http://wsygoogol.github.io/2017/06/29/WAF-Bypass-技巧总结/index.html">
<meta property="og:site_name" content="SY0U&#39;s Blog">
<meta property="og:description" content="waf分类掌握绕过各类WAF可以说是渗透测试人员的一项基本技能，本文将WAF分为云WAF、硬件WAF、软件WAF、代码级WAF，分别从各自的特性来谈一些相关的绕过技巧，更侧重于针对基于规则类的WAF绕过技巧。 1.云WAFEg:加速乐目前CDN服务的功能是越来越多，安全性也越加强悍，用户的每个请求都会被发送到指定的CDN节点上，最后转发给真实站点。这个过程就好像加了一道关卡，这个关卡提供了缓存、加">
<meta property="og:image" content="http://wsygoogol.github.io/upload_image/7.jpg">
<meta property="og:updated_time" content="2017-06-30T07:15:43.140Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WAF Bypass 技巧总结">
<meta name="twitter:description" content="waf分类掌握绕过各类WAF可以说是渗透测试人员的一项基本技能，本文将WAF分为云WAF、硬件WAF、软件WAF、代码级WAF，分别从各自的特性来谈一些相关的绕过技巧，更侧重于针对基于规则类的WAF绕过技巧。 1.云WAFEg:加速乐目前CDN服务的功能是越来越多，安全性也越加强悍，用户的每个请求都会被发送到指定的CDN节点上，最后转发给真实站点。这个过程就好像加了一道关卡，这个关卡提供了缓存、加">
<meta name="twitter:image" content="http://wsygoogol.github.io/upload_image/7.jpg">
  
    <link rel="alternate" href="/atom.xml" title="SY0U&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SY0U&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://wsygoogol.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-WAF-Bypass-技巧总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/29/WAF-Bypass-技巧总结/" class="article-date">
  <time datetime="2017-06-29T12:11:51.000Z" itemprop="datePublished">2017-06-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      WAF Bypass 技巧总结
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="waf分类"><a href="#waf分类" class="headerlink" title="waf分类"></a>waf分类</h4><p>掌握绕过各类WAF可以说是渗透测试人员的一项基本技能，本文将WAF分为云WAF、硬件WAF、软件WAF、代码级WAF，分别从各自的特性来谈一些相关的绕过技巧，更侧重于针对基于规则类的WAF绕过技巧。</p>
<h6 id="1-云WAF"><a href="#1-云WAF" class="headerlink" title="1.云WAF"></a>1.云WAF</h6><p>Eg:加速乐<br>目前CDN服务的功能是越来越多，安全性也越加强悍，用户的每个请求都会被发送到指定的CDN节点上，最后转发给真实站点。这个过程就好像加了一道关卡，这个关卡提供了缓存、加速、防御的特点。<br>绕过关键：查询真实IP，若是直接访问服务器的IP就不经过CDN了。<br>以下四点有助于绕过。<br>1.查询历史DNS（在2016年加入到了cnd节点里面，可以通过查询2016年之前的dns记录）<br>2.查看子域名解析地址是否和主域名的IP地址相近。（有些网站只会将主站加入到CDN节点里面，这时可以查看其二级、三级域名的IP地址信息，进而猜到主站的IP地址）<br>3.CDN节点分发缺陷，通过国外IP访问网站可能会出现真实IP，因为有的CDN服务商可能只做了国内节点，没做国外的，这样访问请求是直接被转发到真实服务器地址上。<br>4.让服务器主动连接你。比如rss订阅服务或则是向邮箱服务器发送个错误的邮件比如地址不存在 通过抓包观察返回的头来,查找IP地址信息。</p>
<h6 id="2-硬件waf"><a href="#2-硬件waf" class="headerlink" title="2.硬件waf"></a>2.硬件waf</h6><p>Eg:绿盟WAF</p>
<h6 id="3-软件waf"><a href="#3-软件waf" class="headerlink" title="3.软件waf"></a>3.软件waf</h6><p>Eg:安全狗</p>
<h4 id="基于规则的WAF工作原理"><a href="#基于规则的WAF工作原理" class="headerlink" title="基于规则的WAF工作原理"></a>基于规则的WAF工作原理</h4><p>数据获取(注意 get post等方法以及 post体方式)———数据清洗(去除多余数据比如编码,mssql支持unicode编码)———规则匹配———二次校验</p>
<h5 id="绕注入"><a href="#绕注入" class="headerlink" title="绕注入"></a>绕注入</h5><h6 id="1-关键字替换"><a href="#1-关键字替换" class="headerlink" title="1.关键字替换"></a>1.关键字替换</h6><p>原理：<br>部分WAF是通过黑名单来起到拦截的作用，这种情况可以用关键字替换来实现绕过。比如在mysql中，waf将sleep()函数列入了黑名单，可以通过具备相同功能的benchmark()函数来实现绕过。以下是部分相同功能的替代函数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt; &gt; 等价于 BETWEEN</div><div class="line">= 等价于 like</div><div class="line">Hex() bin() 等价于ascii()</div><div class="line">Sleep() 等价于 benchmark()</div><div class="line">Mid()substring() 等价于 substr(）</div><div class="line">@@user 等价于 User()</div><div class="line">@@Version 等价于 version()</div><div class="line">(mysql支持&amp;&amp;  || ,oracle不支持 &amp;&amp; ||）</div></pre></td></tr></table></figure></p>
<h6 id="2-特殊符号"><a href="#2-特殊符号" class="headerlink" title="2.特殊符号"></a>2.特殊符号</h6><p>原理：结合不同数据库的特性来实现绕过。(最好是可以找到waf开发者都不了解的某些特性),以下是两个广为流传的小特性：<br>比如 “+” select+password+from+mysql.user 相当于是一个空格的作用“`”放在mysql的末尾会起到注释符的作用</p>
<h6 id="3-编码"><a href="#3-编码" class="headerlink" title="3.编码"></a>3.编码</h6><p>可以结合各种编码方式来绕过,比如url编码，url双重编码,十六进制编码，unicode编码，数据库编码等。<br>Eg：mysql默认的字符集是latin,因此在php代码里面设置的字符集为 utf-8,这只是客户端的字符集，因此存在字符集装换的问题utf-8—&gt;latin,若传进来的字符集不是完整的字符，则会导致不完整的字符自动会忽略的问题，比如username=admin%c2 ,   由于%c2不是一个完整的utf-8字符  因此传到Mysql  里面  自动忽略了，导致查出的是admin用户的数据，可以利用这个特性绕过。</p>
<h6 id="4-注释符"><a href="#4-注释符" class="headerlink" title="4.注释符"></a>4.注释符</h6><p>/<em>xxx</em>/是注释，也可以充当空白符。因为 /<strong>/可使得MySQL对sql语句(union/</strong>/select)词法解析成功。事实上许多WAF都考虑到/<strong>/可以作为空白分，但是waf检测 “/*.<em>\</em>/”很消耗性能，工程师会折中，可能在检测中间引入一些特殊字符，例如：/<em>\w+</em>/。或者，WAF可能只中间检查n个字符“/*.{,n}*/”。根据以上想法，可以逐步测试绕过方法：<br>先测试最基本的：union/</strong>/select再测试中间引入特殊字：union/<em>aaaa%01bbs</em>/select最后测试注释长度：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">union/*aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa*/select</div></pre></td></tr></table></figure></p>
<h6 id="5-空白符绕过"><a href="#5-空白符绕过" class="headerlink" title="5.空白符绕过"></a>5.空白符绕过</h6><p>基于正则表达式的WAF， SQL注入规则使用正则表达式的“\s”匹配空格，例如”select\s+union”。<br>利用空白符进行绕过，测试WAF时尽可能减少其他原因的影响，例如”union select”被拦截，只需把中间空白符替换为”%250C”, “%25A0”进行绕过测试。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">union%250Cselect</div><div class="line">union%25A0select</div></pre></td></tr></table></figure></p>
<p>函数分隔符对基于正则表达式的WAF，我们猜测安全工程师写WAF规则时，可能不知道函数名与左括号之间可以存在特殊字符，或者遗漏可以存在特殊字符。例如匹配函数”concat()”的规则写法，“concat(”或者”concat\s*(”，就没有考虑到一些特殊字符。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">concat%2520(</div><div class="line">concat/**/(</div><div class="line">concat%250c(</div><div class="line">concat%25a0(</div></pre></td></tr></table></figure></p>
<h6 id="6-浮点数词法解析"><a href="#6-浮点数词法解析" class="headerlink" title="6.浮点数词法解析"></a>6.浮点数词法解析</h6><p>利用MySQL解析浮点数的特点，正则表达式无法匹配出单词union，但是MySQL词法解析成功解析出浮点数、sql关键字union。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">select * from users <span class="built_in">where</span> id=8E0union select 1,2,3,4,5,6,7,8,9,0</div><div class="line">select * from users <span class="built_in">where</span> id=8.0union select 1,2,3,4,5,6,7,8,9,0</div></pre></td></tr></table></figure></p>
<h6 id="7-报错注入"><a href="#7-报错注入" class="headerlink" title="7.报错注入"></a>7.报错注入</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">extractvalue(1, concat(0x5c,md5(3)));</div><div class="line">updatexml(1, concat(0x5d,md5(3)),1);</div><div class="line">GeometryCollection((select*from(select*from(select@@version)f)x))</div><div class="line">polygon((select*from(select name_const(version(),1))x))</div><div class="line">linestring()</div><div class="line">multipoint()</div><div class="line">multilinestring()</div><div class="line">multipolygon()</div></pre></td></tr></table></figure>
<h5 id="绕上传"><a href="#绕上传" class="headerlink" title="绕上传"></a>绕上传</h5><p>关键是：waf与webserver的差异（waf的局限性与webserver的灵活性）。</p>
<h6 id="1-协议解析不一致-文件名解析兼容性"><a href="#1-协议解析不一致-文件名解析兼容性" class="headerlink" title="1.协议解析不一致-文件名解析兼容性"></a>1.协议解析不一致-文件名解析兼容性</h6><p>multipart协议中，文件名的形式为“filename=”abc.php””。但是Tomcat、PHP等容器解析协议时会做一些兼容，能正确解析 ”filename=”abc.php”、”filename=abc.php”、 ”filename=’abc.php’”。而WAF只按照协议标准去解析，无法解析文件名，但是后端容器能正确获得文件名，从而导致被绕过。场景的绕过形式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Content-Disposition: form-data; name=<span class="string">"file"</span>; filename=bc.php</div><div class="line">Content-Disposition: form-data; name=<span class="string">"file"</span>; filename=<span class="string">"abc.php</span></div><div class="line">Content-Disposition: form-data; name="file<span class="string">"; filename='abc.php'</span></div></pre></td></tr></table></figure></p>
<h6 id="2-协议解析不正确-未解析所有文件"><a href="#2-协议解析不正确-未解析所有文件" class="headerlink" title="2.协议解析不正确-未解析所有文件"></a>2.协议解析不正确-未解析所有文件</h6><p>multipart协议中，一个POST请求可以同时上传多个文件。如图，许多WAF只检查第一个上传文件，没有检查上传的所有文件，而实际后端容器会解析所有上传的文件名，攻击者只需把paylaod放在后面的文件PART，即可绕过。</p>
<h6 id="3-协议解析不正确-文件名覆盖"><a href="#3-协议解析不正确-文件名覆盖" class="headerlink" title="3.协议解析不正确-文件名覆盖"></a>3.协议解析不正确-文件名覆盖</h6><p>在multipart协议中，一个文件上传块存在多个Content-Disposition，将以最后一个Content-Disposition的filename值作为上传的文件名。许多WAF解析到第一个Content-Disposition就认为协议解析完毕，获得上传的文件名，从而导致被绕过。如图，加速乐的WAF解析得到文件名是”sp.pho”，但PHP解析结果是”sp.php”，导致被绕过。<br><img src="/upload_image/7.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2017/06/29/WAF-Bypass-技巧总结/" data-id="cj4jizcnb00027s1bm6hvcodv" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/06/29/sql注入之数据库识别/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">sql注入之数据库识别</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/29/WAF-Bypass-技巧总结/">WAF Bypass 技巧总结</a>
          </li>
        
          <li>
            <a href="/2017/06/29/sql注入之数据库识别/">sql注入之数据库识别</a>
          </li>
        
          <li>
            <a href="/2017/06/29/Spring-Boot框架SPEL表达式注入漏洞/">Spring Boot框架SPEL表达式注入漏洞</a>
          </li>
        
          <li>
            <a href="/2017/06/29/面试一年前的自己/">面试一年前的自己</a>
          </li>
        
          <li>
            <a href="/2017/06/28/Hexo-搭建Blog教程/">Hexo 搭建Blog教程</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <!--
<footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 SY0U<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
-->

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>